<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>Ù„ÙˆØ­Ø© Ø§Ù„Ø±Ø³Ù… â€” Mishkah Drawing Board</title>
  <style>
    :root {
      --bg: #0f172a;
      --surface-1: rgba(15, 23, 42, 0.95);
      --surface-2: rgba(30, 41, 59, 0.8);
      --surface-3: rgba(51, 65, 85, 0.6);
      --border: rgba(148, 163, 184, 0.2);
      --accent: #6366f1;
      --accent-light: #818cf8;
      --text: #f8fafc;
      --text-muted: rgba(148, 163, 184, 0.8);
      --danger: #ef4444;
      --success: #10b981;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      background: radial-gradient(circle at top, rgba(99, 102, 241, 0.1), transparent 60%), var(--bg);
      color: var(--text);
      font-family: "Inter", "Tajawal", system-ui, sans-serif;
      overflow: hidden;
      height: 100vh;
      touch-action: none;
    }

    /* Main Layout */
    .drawing-app {
      display: grid;
      grid-template-rows: auto 1fr auto;
      height: 100vh;
      gap: 0;
    }

    /* Top Toolbar */
    .toolbar-top {
      background: var(--surface-1);
      border-bottom: 1px solid var(--border);
      padding: 0.8rem 1.2rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
      flex-wrap: wrap;
      backdrop-filter: blur(10px);
    }

    .toolbar-section {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .app-title {
      font-size: 1.3rem;
      font-weight: 700;
      background: linear-gradient(135deg, #6366f1, #22d3ee);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .btn {
      background: var(--surface-2);
      border: 1px solid var(--border);
      color: var(--text);
      padding: 0.5rem 1rem;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 0.4rem;
      white-space: nowrap;
    }

    .btn:hover {
      background: var(--surface-3);
      border-color: var(--accent);
    }

    .btn.active {
      background: var(--accent);
      border-color: var(--accent);
    }

    .btn-icon {
      width: 32px;
      height: 32px;
      padding: 0.4rem;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* Main Canvas Area */
    .canvas-container {
      position: relative;
      display: flex;
      gap: 0;
      overflow: hidden;
    }

    /* Left Sidebar - Tools */
    .sidebar-left {
      width: 80px;
      background: var(--surface-1);
      border-left: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      padding: 1rem 0.5rem;
      overflow-y: auto;
    }

    .tool-btn {
      width: 64px;
      height: 64px;
      background: var(--surface-2);
      border: 2px solid transparent;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 0.3rem;
      color: var(--text-muted);
      font-size: 0.7rem;
    }

    .tool-btn:hover {
      background: var(--surface-3);
      border-color: var(--accent-light);
    }

    .tool-btn.active {
      background: var(--accent);
      border-color: var(--accent);
      color: white;
    }

    .tool-icon {
      font-size: 1.8rem;
    }

    /* Canvas Wrapper */
    .canvas-wrapper {
      flex: 1;
      position: relative;
      background:
        linear-gradient(90deg, rgba(148, 163, 184, 0.05) 1px, transparent 1px),
        linear-gradient(rgba(148, 163, 184, 0.05) 1px, transparent 1px);
      background-size: 20px 20px;
      overflow: auto;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    #drawingCanvas {
      display: block;
      cursor: crosshair;
      background: white;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
    }

    /* Right Sidebar - Properties */
    .sidebar-right {
      width: 280px;
      background: var(--surface-1);
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      gap: 1rem;
      padding: 1rem;
      overflow-y: auto;
    }

    .panel {
      background: var(--surface-2);
      border-radius: 12px;
      padding: 1rem;
      border: 1px solid var(--border);
    }

    .panel-title {
      font-size: 0.9rem;
      font-weight: 600;
      margin-bottom: 0.8rem;
      color: var(--accent-light);
    }

    /* Color Picker */
    .color-grid {
      display: grid;
      grid-template-columns: repeat(6, 1fr);
      gap: 0.4rem;
      margin-bottom: 0.8rem;
    }

    .color-swatch {
      width: 100%;
      aspect-ratio: 1;
      border-radius: 6px;
      border: 2px solid transparent;
      cursor: pointer;
      transition: all 0.2s;
    }

    .color-swatch:hover {
      transform: scale(1.1);
    }

    .color-swatch.active {
      border-color: white;
      box-shadow: 0 0 0 2px var(--accent);
    }

    .custom-color-input {
      width: 100%;
      height: 40px;
      border: 1px solid var(--border);
      border-radius: 8px;
      cursor: pointer;
    }

    /* Brush Size */
    .size-control {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .size-slider {
      width: 100%;
      height: 6px;
      border-radius: 3px;
      background: var(--surface-3);
      -webkit-appearance: none;
      appearance: none;
      outline: none;
    }

    .size-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: var(--accent);
      cursor: pointer;
    }

    .size-slider::-moz-range-thumb {
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: var(--accent);
      cursor: pointer;
      border: none;
    }

    .size-preview {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 60px;
      background: white;
      border-radius: 8px;
    }

    .size-preview-dot {
      background: currentColor;
      border-radius: 50%;
      transition: all 0.2s;
    }

    /* Shapes Panel */
    .shapes-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 0.5rem;
    }

    .shape-btn {
      aspect-ratio: 1;
      background: var(--surface-3);
      border: 2px solid transparent;
      border-radius: 8px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      transition: all 0.2s;
    }

    .shape-btn:hover {
      background: var(--surface-1);
      border-color: var(--accent-light);
    }

    .shape-btn.active {
      background: var(--accent);
      border-color: var(--accent);
    }

    /* Bottom Toolbar */
    .toolbar-bottom {
      background: var(--surface-1);
      border-top: 1px solid var(--border);
      padding: 0.8rem 1.2rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
      backdrop-filter: blur(10px);
    }

    .status-text {
      font-size: 0.85rem;
      color: var(--text-muted);
    }

    /* Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      align-items: center;
      justify-content: center;
      z-index: 1000;
      backdrop-filter: blur(5px);
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      background: var(--surface-1);
      border-radius: 16px;
      padding: 2rem;
      max-width: 500px;
      width: 90%;
      border: 1px solid var(--border);
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
      max-height: 90vh;
      overflow-y: auto;
    }

    .modal-header {
      font-size: 1.3rem;
      font-weight: 700;
      margin-bottom: 1.5rem;
      color: var(--accent-light);
    }

    .form-group {
      margin-bottom: 1rem;
    }

    .form-label {
      display: block;
      margin-bottom: 0.5rem;
      font-size: 0.9rem;
      color: var(--text-muted);
    }

    .form-input {
      width: 100%;
      background: var(--surface-2);
      border: 1px solid var(--border);
      color: var(--text);
      padding: 0.7rem;
      border-radius: 8px;
      font-size: 0.9rem;
    }

    .form-input:focus {
      outline: none;
      border-color: var(--accent);
    }

    .modal-actions {
      display: flex;
      gap: 0.8rem;
      margin-top: 1.5rem;
    }

    .btn-primary {
      background: var(--accent);
      flex: 1;
    }

    .btn-secondary {
      background: var(--surface-2);
      flex: 1;
    }

    /* Files List */
    .files-list {
      max-height: 300px;
      overflow-y: auto;
      margin-bottom: 1rem;
    }

    .file-item {
      background: var(--surface-2);
      padding: 0.8rem;
      border-radius: 8px;
      margin-bottom: 0.5rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border: 1px solid var(--border);
      cursor: pointer;
      transition: all 0.2s;
    }

    .file-item:hover {
      border-color: var(--accent-light);
      background: var(--surface-3);
    }

    .file-info {
      flex: 1;
    }

    .file-name {
      font-weight: 600;
      margin-bottom: 0.2rem;
    }

    .file-meta {
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .file-actions {
      display: flex;
      gap: 0.5rem;
    }

    .btn-small {
      padding: 0.3rem 0.6rem;
      font-size: 0.8rem;
    }

    /* Scrollbar Styling */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    ::-webkit-scrollbar-track {
      background: var(--surface-2);
    }

    ::-webkit-scrollbar-thumb {
      background: var(--surface-3);
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: var(--accent);
    }

    /* File input hidden */
    #imageUpload {
      display: none;
    }

    .hidden {
      display: none !important;
    }
  </style>
</head>
<body>
  <div class="drawing-app">
    <!-- Top Toolbar -->
    <div class="toolbar-top">
      <div class="toolbar-section">
        <h1 class="app-title">ğŸ¨ Ù„ÙˆØ­Ø© Ø§Ù„Ø±Ø³Ù…</h1>
      </div>

      <div class="toolbar-section">
        <button class="btn" onclick="app.undo()">
          <span>â†¶</span>
          <span>ØªØ±Ø§Ø¬Ø¹</span>
        </button>
        <button class="btn" onclick="app.redo()">
          <span>â†·</span>
          <span>Ø¥Ø¹Ø§Ø¯Ø©</span>
        </button>
        <button class="btn" onclick="app.clearCanvas()">
          <span>ğŸ—‘ï¸</span>
          <span>Ù…Ø³Ø­ Ø§Ù„ÙƒÙ„</span>
        </button>
      </div>

      <div class="toolbar-section">
        <button class="btn" onclick="app.openSaveModal()">
          <span>ğŸ’¾</span>
          <span>Ø­ÙØ¸</span>
        </button>
        <button class="btn" onclick="app.openLoadModal()">
          <span>ğŸ“</span>
          <span>ÙØªØ­</span>
        </button>
        <button class="btn" onclick="app.openExportModal()">
          <span>ğŸ“¤</span>
          <span>ØªØµØ¯ÙŠØ±</span>
        </button>
      </div>
    </div>

    <!-- Main Canvas Area -->
    <div class="canvas-container">
      <!-- Left Sidebar - Tools -->
      <div class="sidebar-left">
        <button class="tool-btn active" onclick="app.setTool('pen')" data-tool="pen">
          <span class="tool-icon">âœï¸</span>
          <span>Ù‚Ù„Ù…</span>
        </button>

        <button class="tool-btn" onclick="app.setTool('brush')" data-tool="brush">
          <span class="tool-icon">ğŸ–Œï¸</span>
          <span>ÙØ±Ø´Ø§Ø©</span>
        </button>

        <button class="tool-btn" onclick="app.setTool('eraser')" data-tool="eraser">
          <span class="tool-icon">ğŸ§¹</span>
          <span>Ù…Ù…Ø­Ø§Ø©</span>
        </button>

        <button class="tool-btn" onclick="app.setTool('line')" data-tool="line">
          <span class="tool-icon">ğŸ“</span>
          <span>Ø®Ø·</span>
        </button>

        <button class="tool-btn" onclick="app.setTool('rectangle')" data-tool="rectangle">
          <span class="tool-icon">â–­</span>
          <span>Ù…Ø±Ø¨Ø¹</span>
        </button>

        <button class="tool-btn" onclick="app.setTool('circle')" data-tool="circle">
          <span class="tool-icon">â­•</span>
          <span>Ø¯Ø§Ø¦Ø±Ø©</span>
        </button>

        <button class="tool-btn" onclick="app.setTool('arrow')" data-tool="arrow">
          <span class="tool-icon">â¡ï¸</span>
          <span>Ø³Ù‡Ù…</span>
        </button>

        <button class="tool-btn" onclick="app.setTool('text')" data-tool="text">
          <span class="tool-icon">ğŸ“</span>
          <span>Ù†Øµ</span>
        </button>

        <button class="tool-btn" onclick="app.importImage()">
          <span class="tool-icon">ğŸ–¼ï¸</span>
          <span>ØµÙˆØ±Ø©</span>
        </button>
      </div>

      <!-- Canvas -->
      <div class="canvas-wrapper">
        <canvas id="drawingCanvas" width="1200" height="800"></canvas>
      </div>

      <!-- Right Sidebar - Properties -->
      <div class="sidebar-right">
        <!-- Colors Panel -->
        <div class="panel">
          <h3 class="panel-title">ğŸ¨ Ø§Ù„Ø£Ù„ÙˆØ§Ù†</h3>
          <div class="color-grid" id="colorGrid"></div>
          <input
            type="color"
            class="custom-color-input"
            id="customColor"
            value="#000000"
          />
        </div>

        <!-- Brush Size Panel -->
        <div class="panel">
          <h3 class="panel-title">ğŸ“ Ø­Ø¬Ù… Ø§Ù„ÙØ±Ø´Ø§Ø©: <span id="brushSizeLabel">3</span>px</h3>
          <div class="size-control">
            <input
              type="range"
              class="size-slider"
              id="brushSize"
              min="1"
              max="50"
              value="3"
            />
            <div class="size-preview">
              <div id="sizePreviewDot" class="size-preview-dot"></div>
            </div>
          </div>
        </div>

        <!-- Shapes Panel -->
        <div class="panel">
          <h3 class="panel-title">ğŸ”¶ Ø£Ø´ÙƒØ§Ù„ Ø¬Ø§Ù‡Ø²Ø©</h3>
          <div class="shapes-grid">
            <button class="shape-btn" onclick="app.insertShape('star')">â­</button>
            <button class="shape-btn" onclick="app.insertShape('heart')">â¤ï¸</button>
            <button class="shape-btn" onclick="app.insertShape('triangle')">ğŸ”º</button>
            <button class="shape-btn" onclick="app.insertShape('hexagon')">â¬¡</button>
            <button class="shape-btn" onclick="app.insertShape('pentagon')">â¬Ÿ</button>
            <button class="shape-btn" onclick="app.insertShape('diamond')">ğŸ’</button>
          </div>
        </div>

        <!-- History Info -->
        <div class="panel">
          <h3 class="panel-title">ğŸ“Š Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</h3>
          <div style="font-size: 0.85rem; color: var(--text-muted);">
            <div style="margin-bottom: 0.5rem;">
              <strong>Ø§Ù„ØªØ§Ø±ÙŠØ®:</strong> <span id="historyInfo">1 / 1</span>
            </div>
            <div>
              <strong>Ø§Ù„Ø£Ø¯Ø§Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©:</strong> <span id="currentToolLabel">pen</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Bottom Toolbar -->
    <div class="toolbar-bottom">
      <div class="status-text" id="statusLeft">
        Ø¬Ø§Ù‡Ø² Ù„Ù„Ø±Ø³Ù… | Ø§Ù„Ø£Ø¯Ø§Ø©: <span id="toolStatus">pen</span> | Ø§Ù„Ù„ÙˆÙ†: <span id="colorStatus">#000000</span>
      </div>
      <div class="status-text" id="statusRight">
        Ø¢Ø®Ø± Ø­ÙØ¸: <span id="lastSaved">Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ø¹Ø¯</span>
      </div>
    </div>
  </div>

  <!-- Save Modal -->
  <div class="modal" id="saveModal">
    <div class="modal-content">
      <h2 class="modal-header">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø±Ø³Ù…Ø©</h2>
      <div class="form-group">
        <label class="form-label">Ø§Ø³Ù… Ø§Ù„Ø±Ø³Ù…Ø©</label>
        <input
          type="text"
          class="form-input"
          id="saveName"
          placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ø±Ø³Ù…Ø©..."
        />
      </div>
      <div class="form-group">
        <label class="form-label">Ø§Ù„Ù…Ø¬Ù„Ø¯</label>
        <input
          type="text"
          class="form-input"
          id="saveFolder"
          placeholder="Ø§Ø®ØªÙŠØ§Ø±ÙŠ: Ø§Ø³Ù… Ø§Ù„Ù…Ø¬Ù„Ø¯"
        />
      </div>
      <div class="modal-actions">
        <button class="btn btn-secondary" onclick="app.closeSaveModal()">Ø¥Ù„ØºØ§Ø¡</button>
        <button class="btn btn-primary" onclick="app.saveDrawing()">Ø­ÙØ¸</button>
      </div>
    </div>
  </div>

  <!-- Load Modal -->
  <div class="modal" id="loadModal">
    <div class="modal-content">
      <h2 class="modal-header">ğŸ“ ÙØªØ­ Ø±Ø³Ù…Ø©</h2>
      <div class="files-list" id="filesList"></div>
      <div class="modal-actions">
        <button class="btn btn-secondary" onclick="app.closeLoadModal()">Ø¥ØºÙ„Ø§Ù‚</button>
      </div>
    </div>
  </div>

  <!-- Export Modal -->
  <div class="modal" id="exportModal">
    <div class="modal-content">
      <h2 class="modal-header">ğŸ“¤ ØªØµØ¯ÙŠØ± Ø§Ù„Ø±Ø³Ù…Ø©</h2>
      <div class="modal-actions" style="flex-direction: column;">
        <button class="btn btn-primary" onclick="app.exportAsPNG()">ØªØµØ¯ÙŠØ± ÙƒÙ€ PNG</button>
        <button class="btn btn-primary" onclick="app.exportAsJPG()">ØªØµØ¯ÙŠØ± ÙƒÙ€ JPG</button>
        <button class="btn btn-primary" onclick="app.exportAsPDF()">ØªØµØ¯ÙŠØ± ÙƒÙ€ PDF</button>
        <button class="btn btn-secondary" onclick="app.closeExportModal()">Ø¥Ù„ØºØ§Ø¡</button>
      </div>
    </div>
  </div>

  <!-- Hidden file input for image upload -->
  <input type="file" id="imageUpload" accept="image/*" />

  <!-- jsPDF for PDF export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <script>
    // Drawing Application
    const app = {
      // State
      currentTool: 'pen',
      currentColor: '#000000',
      brushSize: 3,
      isDrawing: false,
      startX: 0,
      startY: 0,
      history: [],
      historyIndex: -1,
      lastSaved: null,

      // Available colors
      colors: [
        '#000000', '#FFFFFF', '#FF0000', '#00FF00', '#0000FF', '#FFFF00',
        '#FF00FF', '#00FFFF', '#FFA500', '#800080', '#008000', '#800000',
        '#808080', '#C0C0C0', '#FFB6C1', '#87CEEB', '#90EE90', '#DDA0DD'
      ],

      // Initialize
      init() {
        this.canvas = document.getElementById('drawingCanvas');
        this.ctx = this.canvas.getContext('2d');

        // Set up canvas
        this.ctx.lineCap = 'round';
        this.ctx.lineJoin = 'round';
        this.ctx.fillStyle = 'white';
        this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);

        // Save initial state
        this.saveState();

        // Set up event listeners
        this.setupEventListeners();

        // Render colors
        this.renderColors();

        // Update UI
        this.updateUI();

        console.log('ğŸ¨ Drawing board ready!');
      },

      setupEventListeners() {
        // Canvas events
        this.canvas.addEventListener('mousedown', (e) => this.startDrawing(e));
        this.canvas.addEventListener('mousemove', (e) => this.draw(e));
        this.canvas.addEventListener('mouseup', (e) => this.stopDrawing(e));
        this.canvas.addEventListener('mouseout', () => this.stopDrawing());

        // Touch events
        this.canvas.addEventListener('touchstart', (e) => this.handleTouch(e, 'start'));
        this.canvas.addEventListener('touchmove', (e) => this.handleTouch(e, 'move'));
        this.canvas.addEventListener('touchend', () => this.stopDrawing());

        // Color picker
        document.getElementById('customColor').addEventListener('input', (e) => {
          this.currentColor = e.target.value;
          this.updateUI();
        });

        // Brush size
        document.getElementById('brushSize').addEventListener('input', (e) => {
          this.brushSize = parseInt(e.target.value);
          this.updateUI();
        });

        // Image upload
        document.getElementById('imageUpload').addEventListener('change', (e) => this.handleImageUpload(e));

        // Close modals on outside click
        ['saveModal', 'loadModal', 'exportModal'].forEach(id => {
          const modal = document.getElementById(id);
          modal.addEventListener('click', (e) => {
            if (e.target === modal) {
              modal.classList.remove('active');
            }
          });
        });
      },

      renderColors() {
        const grid = document.getElementById('colorGrid');
        grid.innerHTML = '';
        this.colors.forEach(color => {
          const swatch = document.createElement('div');
          swatch.className = 'color-swatch';
          swatch.style.backgroundColor = color;
          if (color === this.currentColor) swatch.classList.add('active');
          swatch.addEventListener('click', () => {
            this.currentColor = color;
            document.getElementById('customColor').value = color;
            this.updateUI();
            this.renderColors();
          });
          grid.appendChild(swatch);
        });
      },

      updateUI() {
        // Update labels
        document.getElementById('brushSizeLabel').textContent = this.brushSize;
        document.getElementById('currentToolLabel').textContent = this.currentTool;
        document.getElementById('toolStatus').textContent = this.currentTool;
        document.getElementById('colorStatus').textContent = this.currentColor;
        document.getElementById('historyInfo').textContent = `${this.historyIndex + 1} / ${this.history.length}`;

        // Update size preview
        const dot = document.getElementById('sizePreviewDot');
        dot.style.width = this.brushSize + 'px';
        dot.style.height = this.brushSize + 'px';
        dot.style.backgroundColor = this.currentColor;

        // Update tool buttons
        document.querySelectorAll('.tool-btn').forEach(btn => {
          btn.classList.remove('active');
          if (btn.dataset.tool === this.currentTool) {
            btn.classList.add('active');
          }
        });
      },

      handleTouch(e, type) {
        e.preventDefault();
        const touch = e.touches[0];
        if (touch) {
          const mouseEvent = new MouseEvent(
            type === 'start' ? 'mousedown' : 'mousemove',
            {
              clientX: touch.clientX,
              clientY: touch.clientY
            }
          );
          this.canvas.dispatchEvent(mouseEvent);
        }
      },

      getMousePos(e) {
        const rect = this.canvas.getBoundingClientRect();
        return {
          x: e.clientX - rect.left,
          y: e.clientY - rect.top
        };
      },

      startDrawing(e) {
        this.isDrawing = true;
        const pos = this.getMousePos(e);
        this.startX = pos.x;
        this.startY = pos.y;

        if (this.currentTool === 'pen' || this.currentTool === 'brush') {
          this.ctx.beginPath();
          this.ctx.moveTo(pos.x, pos.y);
        } else if (this.currentTool === 'text') {
          this.drawText(pos.x, pos.y);
          this.isDrawing = false;
          this.saveState();
        }
      },

      draw(e) {
        if (!this.isDrawing) return;

        const pos = this.getMousePos(e);
        const ctx = this.ctx;

        if (this.currentTool === 'pen' || this.currentTool === 'brush') {
          ctx.strokeStyle = this.currentColor;
          ctx.lineWidth = this.currentTool === 'brush' ? this.brushSize * 2 : this.brushSize;
          ctx.lineTo(pos.x, pos.y);
          ctx.stroke();
        } else if (this.currentTool === 'eraser') {
          ctx.clearRect(
            pos.x - this.brushSize,
            pos.y - this.brushSize,
            this.brushSize * 2,
            this.brushSize * 2
          );
        }
      },

      stopDrawing(e) {
        if (!this.isDrawing) return;

        if (e) {
          const pos = this.getMousePos(e);

          if (this.currentTool === 'line') {
            this.drawLine(this.startX, this.startY, pos.x, pos.y);
          } else if (this.currentTool === 'rectangle') {
            this.drawRectangle(this.startX, this.startY, pos.x, pos.y);
          } else if (this.currentTool === 'circle') {
            this.drawCircle(this.startX, this.startY, pos.x, pos.y);
          } else if (this.currentTool === 'arrow') {
            this.drawArrow(this.startX, this.startY, pos.x, pos.y);
          }
        }

        this.isDrawing = false;
        this.saveState();
      },

      drawLine(x1, y1, x2, y2) {
        const ctx = this.ctx;
        ctx.strokeStyle = this.currentColor;
        ctx.lineWidth = this.brushSize;
        ctx.beginPath();
        ctx.moveTo(x1, y1);
        ctx.lineTo(x2, y2);
        ctx.stroke();
      },

      drawRectangle(x1, y1, x2, y2) {
        const ctx = this.ctx;
        ctx.strokeStyle = this.currentColor;
        ctx.lineWidth = this.brushSize;
        ctx.strokeRect(x1, y1, x2 - x1, y2 - y1);
      },

      drawCircle(x1, y1, x2, y2) {
        const ctx = this.ctx;
        const radius = Math.sqrt(Math.pow(x2 - x1, 2) + Math.pow(y2 - y1, 2));
        ctx.strokeStyle = this.currentColor;
        ctx.lineWidth = this.brushSize;
        ctx.beginPath();
        ctx.arc(x1, y1, radius, 0, 2 * Math.PI);
        ctx.stroke();
      },

      drawArrow(x1, y1, x2, y2) {
        const ctx = this.ctx;
        const headlen = 15;
        const angle = Math.atan2(y2 - y1, x2 - x1);

        ctx.strokeStyle = this.currentColor;
        ctx.lineWidth = this.brushSize;

        // Draw line
        ctx.beginPath();
        ctx.moveTo(x1, y1);
        ctx.lineTo(x2, y2);
        ctx.stroke();

        // Draw arrow head
        ctx.beginPath();
        ctx.moveTo(x2, y2);
        ctx.lineTo(x2 - headlen * Math.cos(angle - Math.PI / 6), y2 - headlen * Math.sin(angle - Math.PI / 6));
        ctx.moveTo(x2, y2);
        ctx.lineTo(x2 - headlen * Math.cos(angle + Math.PI / 6), y2 - headlen * Math.sin(angle + Math.PI / 6));
        ctx.stroke();
      },

      drawText(x, y) {
        const text = prompt('Ø£Ø¯Ø®Ù„ Ø§Ù„Ù†Øµ:');
        if (text) {
          const ctx = this.ctx;
          ctx.fillStyle = this.currentColor;
          ctx.font = (this.brushSize * 5) + 'px Arial';
          ctx.fillText(text, x, y);
        }
      },

      insertShape(shape) {
        const ctx = this.ctx;
        const centerX = this.canvas.width / 2;
        const centerY = this.canvas.height / 2;
        const size = 50;

        ctx.fillStyle = this.currentColor;
        ctx.strokeStyle = this.currentColor;
        ctx.lineWidth = this.brushSize;

        switch(shape) {
          case 'star':
            this.drawStar(centerX, centerY, 5, size, size/2);
            break;
          case 'heart':
            this.drawHeart(centerX, centerY, size);
            break;
          case 'triangle':
            this.drawTriangle(centerX, centerY, size);
            break;
          case 'hexagon':
            this.drawPolygon(centerX, centerY, 6, size);
            break;
          case 'pentagon':
            this.drawPolygon(centerX, centerY, 5, size);
            break;
          case 'diamond':
            this.drawDiamond(centerX, centerY, size);
            break;
        }

        this.saveState();
      },

      drawStar(cx, cy, spikes, outerRadius, innerRadius) {
        const ctx = this.ctx;
        let rot = Math.PI / 2 * 3;
        let x = cx;
        let y = cy;
        const step = Math.PI / spikes;

        ctx.beginPath();
        ctx.moveTo(cx, cy - outerRadius);

        for (let i = 0; i < spikes; i++) {
          x = cx + Math.cos(rot) * outerRadius;
          y = cy + Math.sin(rot) * outerRadius;
          ctx.lineTo(x, y);
          rot += step;

          x = cx + Math.cos(rot) * innerRadius;
          y = cy + Math.sin(rot) * innerRadius;
          ctx.lineTo(x, y);
          rot += step;
        }

        ctx.lineTo(cx, cy - outerRadius);
        ctx.closePath();
        ctx.stroke();
      },

      drawHeart(cx, cy, size) {
        const ctx = this.ctx;
        ctx.beginPath();
        const topCurveHeight = size * 0.3;
        ctx.moveTo(cx, cy + topCurveHeight);
        ctx.bezierCurveTo(cx, cy, cx - size / 2, cy - size / 2, cx - size / 2, cy + topCurveHeight);
        ctx.bezierCurveTo(cx - size / 2, cy + (size + topCurveHeight) / 2, cx, cy + (size + topCurveHeight) / 2, cx, cy + size);
        ctx.bezierCurveTo(cx, cy + (size + topCurveHeight) / 2, cx + size / 2, cy + (size + topCurveHeight) / 2, cx + size / 2, cy + topCurveHeight);
        ctx.bezierCurveTo(cx + size / 2, cy - size / 2, cx, cy, cx, cy + topCurveHeight);
        ctx.closePath();
        ctx.stroke();
      },

      drawTriangle(cx, cy, size) {
        const ctx = this.ctx;
        ctx.beginPath();
        ctx.moveTo(cx, cy - size);
        ctx.lineTo(cx - size, cy + size);
        ctx.lineTo(cx + size, cy + size);
        ctx.closePath();
        ctx.stroke();
      },

      drawPolygon(cx, cy, sides, size) {
        const ctx = this.ctx;
        ctx.beginPath();
        for (let i = 0; i < sides; i++) {
          const angle = (i * 2 * Math.PI) / sides - Math.PI / 2;
          const x = cx + size * Math.cos(angle);
          const y = cy + size * Math.sin(angle);
          if (i === 0) {
            ctx.moveTo(x, y);
          } else {
            ctx.lineTo(x, y);
          }
        }
        ctx.closePath();
        ctx.stroke();
      },

      drawDiamond(cx, cy, size) {
        const ctx = this.ctx;
        ctx.beginPath();
        ctx.moveTo(cx, cy - size);
        ctx.lineTo(cx + size, cy);
        ctx.lineTo(cx, cy + size);
        ctx.lineTo(cx - size, cy);
        ctx.closePath();
        ctx.stroke();
      },

      // Tools
      setTool(tool) {
        this.currentTool = tool;
        this.updateUI();
      },

      // History
      saveState() {
        // Remove any states after current index
        this.history = this.history.slice(0, this.historyIndex + 1);

        // Save current state
        this.history.push(this.canvas.toDataURL());
        this.historyIndex++;

        // Limit history to 50 states
        if (this.history.length > 50) {
          this.history.shift();
          this.historyIndex--;
        }

        this.updateUI();
      },

      restoreState(index) {
        const img = new Image();
        img.src = this.history[index];
        img.onload = () => {
          this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
          this.ctx.drawImage(img, 0, 0);
        };
      },

      undo() {
        if (this.historyIndex > 0) {
          this.historyIndex--;
          this.restoreState(this.historyIndex);
          this.updateUI();
        }
      },

      redo() {
        if (this.historyIndex < this.history.length - 1) {
          this.historyIndex++;
          this.restoreState(this.historyIndex);
          this.updateUI();
        }
      },

      clearCanvas() {
        if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ù…Ø³Ø­ Ø§Ù„Ù„ÙˆØ­Ø©ØŸ')) {
          this.ctx.fillStyle = 'white';
          this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
          this.saveState();
        }
      },

      // Image Import
      importImage() {
        document.getElementById('imageUpload').click();
      },

      handleImageUpload(e) {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = (event) => {
            const img = new Image();
            img.onload = () => {
              this.ctx.drawImage(img, 0, 0);
              this.saveState();
            };
            img.src = event.target.result;
          };
          reader.readAsDataURL(file);
        }
      },

      // Modals
      openSaveModal() {
        document.getElementById('saveModal').classList.add('active');
      },

      closeSaveModal() {
        document.getElementById('saveModal').classList.remove('active');
        document.getElementById('saveName').value = '';
        document.getElementById('saveFolder').value = '';
      },

      openLoadModal() {
        document.getElementById('loadModal').classList.add('active');
        this.loadSavedFiles();
      },

      closeLoadModal() {
        document.getElementById('loadModal').classList.remove('active');
      },

      openExportModal() {
        document.getElementById('exportModal').classList.add('active');
      },

      closeExportModal() {
        document.getElementById('exportModal').classList.remove('active');
      },

      // Save/Load
      saveDrawing() {
        const name = document.getElementById('saveName').value.trim();
        const folder = document.getElementById('saveFolder').value.trim();

        if (!name) {
          alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ù„Ù„Ø±Ø³Ù…Ø©');
          return;
        }

        const drawing = {
          id: Date.now(),
          name: name,
          folder: folder,
          data: this.canvas.toDataURL(),
          date: new Date().toLocaleDateString('ar-SA')
        };

        // Get existing drawings
        let drawings = JSON.parse(localStorage.getItem('drawings') || '[]');
        drawings.push(drawing);
        localStorage.setItem('drawings', JSON.stringify(drawings));

        this.lastSaved = drawing.date;
        document.getElementById('lastSaved').textContent = drawing.date;
        this.closeSaveModal();
        alert('ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­!');
      },

      loadSavedFiles() {
        const drawings = JSON.parse(localStorage.getItem('drawings') || '[]');
        const list = document.getElementById('filesList');

        if (drawings.length === 0) {
          list.innerHTML = '<div style="text-align: center; padding: 2rem; color: var(--text-muted);">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±Ø³ÙˆÙ…Ø§Øª Ù…Ø­ÙÙˆØ¸Ø©</div>';
          return;
        }

        list.innerHTML = '';
        drawings.reverse().forEach(drawing => {
          const item = document.createElement('div');
          item.className = 'file-item';
          item.innerHTML = `
            <div class="file-info">
              <div class="file-name">${drawing.name}</div>
              <div class="file-meta">${drawing.folder || 'Ø¨Ø¯ÙˆÙ† Ù…Ø¬Ù„Ø¯'} â€¢ ${drawing.date}</div>
            </div>
            <div class="file-actions">
              <button class="btn btn-small" onclick="app.deleteDrawing(${drawing.id}); event.stopPropagation();">ğŸ—‘ï¸</button>
            </div>
          `;
          item.addEventListener('click', () => this.loadDrawing(drawing.id));
          list.appendChild(item);
        });
      },

      loadDrawing(id) {
        const drawings = JSON.parse(localStorage.getItem('drawings') || '[]');
        const drawing = drawings.find(d => d.id === id);

        if (drawing) {
          const img = new Image();
          img.onload = () => {
            this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
            this.ctx.drawImage(img, 0, 0);
            this.saveState();
            this.closeLoadModal();
          };
          img.src = drawing.data;
        }
      },

      deleteDrawing(id) {
        if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø±Ø³Ù…Ø©ØŸ')) {
          let drawings = JSON.parse(localStorage.getItem('drawings') || '[]');
          drawings = drawings.filter(d => d.id !== id);
          localStorage.setItem('drawings', JSON.stringify(drawings));
          this.loadSavedFiles();
        }
      },

      // Export
      exportAsPNG() {
        const link = document.createElement('a');
        const name = document.getElementById('saveName').value.trim() || 'drawing';
        link.download = name + '.png';
        link.href = this.canvas.toDataURL();
        link.click();
        this.closeExportModal();
      },

      exportAsJPG() {
        const link = document.createElement('a');
        const name = document.getElementById('saveName').value.trim() || 'drawing';
        link.download = name + '.jpg';
        link.href = this.canvas.toDataURL('image/jpeg');
        link.click();
        this.closeExportModal();
      },

      exportAsPDF() {
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF({
          orientation: 'landscape',
          unit: 'px',
          format: [this.canvas.width, this.canvas.height]
        });

        const name = document.getElementById('saveName').value.trim() || 'drawing';
        pdf.addImage(this.canvas.toDataURL(), 'PNG', 0, 0, this.canvas.width, this.canvas.height);
        pdf.save(name + '.pdf');
        this.closeExportModal();
      }
    };

    // Initialize when DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => app.init());
    } else {
      app.init();
    }
  </script>
</body>
</html>
