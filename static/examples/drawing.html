<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>ŸÑŸàÿ≠ÿ© ÿßŸÑÿ±ÿ≥ŸÖ ‚Äî Mishkah Drawing Board</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: "Inter", "Tajawal", system-ui, sans-serif;
      overflow: hidden;
      height: 100vh;
      width: 100vw;
      touch-action: none;
      background: #0f172a;
    }

    /* Canvas fills entire screen */
    #drawingCanvas {
      position: absolute;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: white;
      cursor: crosshair;
    }

    /* Floating Top Toolbar - minimal and transparent */
    .floating-toolbar {
      position: fixed;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(15, 23, 42, 0.85);
      backdrop-filter: blur(10px);
      border-radius: 12px;
      padding: 8px 12px;
      display: flex;
      gap: 8px;
      align-items: center;
      z-index: 1000;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    }

    /* Toolbar buttons - small and compact */
    .toolbar-btn {
      background: rgba(51, 65, 85, 0.6);
      border: 1px solid rgba(148, 163, 184, 0.3);
      color: #f8fafc;
      padding: 6px 10px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.8rem;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 4px;
      white-space: nowrap;
    }

    .toolbar-btn:hover,
    .toolbar-btn.active {
      background: #6366f1;
      border-color: #6366f1;
    }

    .toolbar-btn-icon {
      font-size: 1rem;
    }

    /* Side Toggle Buttons - minimal */
    .toggle-btn {
      position: fixed;
      background: rgba(15, 23, 42, 0.85);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(148, 163, 184, 0.3);
      color: #f8fafc;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
      z-index: 1000;
      transition: all 0.2s;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }

    .toggle-btn:hover {
      background: #6366f1;
      transform: scale(1.1);
    }

    #toggleTools {
      left: 10px;
      top: 50%;
      transform: translateY(-50%);
    }

    #toggleColors {
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
    }

    /* Floating Panels */
    .floating-panel {
      position: fixed;
      background: rgba(15, 23, 42, 0.95);
      backdrop-filter: blur(15px);
      border-radius: 16px;
      padding: 16px;
      z-index: 999;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
      border: 1px solid rgba(148, 163, 184, 0.2);
      max-height: 80vh;
      overflow-y: auto;
      display: none;
    }

    .floating-panel.show {
      display: block;
      animation: slideIn 0.2s ease-out;
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    #toolsPanel {
      left: 10px;
      top: 60px;
      width: 200px;
    }

    #colorsPanel {
      right: 10px;
      top: 60px;
      width: 260px;
    }

    .panel-header {
      color: #818cf8;
      font-size: 0.9rem;
      font-weight: 600;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .close-panel {
      background: none;
      border: none;
      color: #f8fafc;
      cursor: pointer;
      font-size: 1.2rem;
      padding: 0;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 4px;
    }

    .close-panel:hover {
      background: rgba(239, 68, 68, 0.2);
    }

    /* Tools Grid */
    .tools-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 8px;
    }

    .tool-item {
      background: rgba(51, 65, 85, 0.6);
      border: 2px solid transparent;
      border-radius: 10px;
      padding: 10px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      color: rgba(248, 250, 252, 0.8);
      font-size: 0.7rem;
    }

    .tool-item:hover {
      background: rgba(51, 65, 85, 0.9);
      border-color: #818cf8;
    }

    .tool-item.active {
      background: #6366f1;
      border-color: #6366f1;
      color: white;
    }

    .tool-item-icon {
      font-size: 1.6rem;
    }

    /* Colors Section */
    .color-grid {
      display: grid;
      grid-template-columns: repeat(6, 1fr);
      gap: 6px;
      margin-bottom: 12px;
    }

    .color-swatch {
      width: 100%;
      aspect-ratio: 1;
      border-radius: 8px;
      border: 2px solid transparent;
      cursor: pointer;
      transition: all 0.2s;
    }

    .color-swatch:hover {
      transform: scale(1.1);
    }

    .color-swatch.active {
      border-color: white;
      box-shadow: 0 0 0 2px #6366f1;
    }

    .custom-color-wrapper {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
    }

    .custom-color-input {
      flex: 1;
      height: 40px;
      border: 1px solid rgba(148, 163, 184, 0.3);
      border-radius: 8px;
      cursor: pointer;
      background: transparent;
    }

    /* Brush Size */
    .size-section {
      margin-bottom: 12px;
    }

    .size-label {
      color: #818cf8;
      font-size: 0.8rem;
      margin-bottom: 6px;
      display: block;
    }

    .size-slider {
      width: 100%;
      height: 6px;
      border-radius: 3px;
      background: rgba(51, 65, 85, 0.6);
      -webkit-appearance: none;
      appearance: none;
      outline: none;
      margin-bottom: 8px;
    }

    .size-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: #6366f1;
      cursor: pointer;
    }

    .size-slider::-moz-range-thumb {
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: #6366f1;
      cursor: pointer;
      border: none;
    }

    .size-preview {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 50px;
      background: white;
      border-radius: 8px;
    }

    .size-preview-dot {
      background: currentColor;
      border-radius: 50%;
      transition: all 0.2s;
    }

    /* Shapes Grid */
    .shapes-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 6px;
    }

    .shape-btn {
      aspect-ratio: 1;
      background: rgba(51, 65, 85, 0.6);
      border: 2px solid transparent;
      border-radius: 8px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.4rem;
      transition: all 0.2s;
    }

    .shape-btn:hover {
      background: rgba(51, 65, 85, 0.9);
      border-color: #818cf8;
    }

    /* Bottom Status Bar - minimal */
    .status-bar {
      position: fixed;
      bottom: 10px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(15, 23, 42, 0.75);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      padding: 6px 16px;
      font-size: 0.75rem;
      color: rgba(248, 250, 252, 0.8);
      z-index: 1000;
      display: flex;
      gap: 12px;
      align-items: center;
    }

    .status-divider {
      width: 1px;
      height: 12px;
      background: rgba(148, 163, 184, 0.3);
    }

    /* Modals */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      align-items: center;
      justify-content: center;
      z-index: 2000;
      backdrop-filter: blur(5px);
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      background: rgba(15, 23, 42, 0.98);
      border-radius: 16px;
      padding: 24px;
      max-width: 500px;
      width: 90%;
      border: 1px solid rgba(148, 163, 184, 0.2);
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
      max-height: 90vh;
      overflow-y: auto;
    }

    .modal-header {
      font-size: 1.3rem;
      font-weight: 700;
      margin-bottom: 20px;
      color: #818cf8;
    }

    .form-group {
      margin-bottom: 16px;
    }

    .form-label {
      display: block;
      margin-bottom: 6px;
      font-size: 0.9rem;
      color: rgba(248, 250, 252, 0.8);
    }

    .form-input {
      width: 100%;
      background: rgba(30, 41, 59, 0.8);
      border: 1px solid rgba(148, 163, 184, 0.3);
      color: #f8fafc;
      padding: 10px;
      border-radius: 8px;
      font-size: 0.9rem;
    }

    .form-input:focus {
      outline: none;
      border-color: #6366f1;
    }

    .modal-actions {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }

    .btn {
      flex: 1;
      padding: 10px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.9rem;
      border: none;
      transition: all 0.2s;
    }

    .btn-primary {
      background: #6366f1;
      color: white;
    }

    .btn-primary:hover {
      background: #5558e3;
    }

    .btn-secondary {
      background: rgba(51, 65, 85, 0.6);
      color: #f8fafc;
    }

    .btn-secondary:hover {
      background: rgba(51, 65, 85, 0.9);
    }

    /* Files List */
    .files-list {
      max-height: 400px;
      overflow-y: auto;
      margin-bottom: 16px;
    }

    .file-item {
      background: rgba(30, 41, 59, 0.6);
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border: 1px solid rgba(148, 163, 184, 0.2);
      cursor: pointer;
      transition: all 0.2s;
    }

    .file-item:hover {
      border-color: #818cf8;
      background: rgba(30, 41, 59, 0.8);
    }

    .file-info {
      flex: 1;
    }

    .file-name {
      font-weight: 600;
      margin-bottom: 4px;
      color: #f8fafc;
    }

    .file-meta {
      font-size: 0.75rem;
      color: rgba(148, 163, 184, 0.8);
    }

    .file-actions {
      display: flex;
      gap: 6px;
    }

    .btn-small {
      padding: 4px 8px;
      font-size: 0.8rem;
      background: rgba(239, 68, 68, 0.2);
      border: 1px solid rgba(239, 68, 68, 0.3);
      color: #f8fafc;
      border-radius: 6px;
      cursor: pointer;
    }

    .btn-small:hover {
      background: rgba(239, 68, 68, 0.4);
    }

    /* Scrollbar */
    ::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }

    ::-webkit-scrollbar-track {
      background: rgba(30, 41, 59, 0.5);
    }

    ::-webkit-scrollbar-thumb {
      background: rgba(99, 102, 241, 0.5);
      border-radius: 3px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #6366f1;
    }

    #imageUpload {
      display: none;
    }

    .section-divider {
      height: 1px;
      background: rgba(148, 163, 184, 0.2);
      margin: 12px 0;
    }
  </style>
</head>
<body>
  <!-- Main Canvas - fills entire screen -->
  <canvas id="drawingCanvas"></canvas>

  <!-- Floating Top Toolbar -->
  <div class="floating-toolbar">
    <button class="toolbar-btn" onclick="app.undo()">
      <span class="toolbar-btn-icon">‚Ü∂</span>
      <span>ÿ™ÿ±ÿßÿ¨ÿπ</span>
    </button>
    <button class="toolbar-btn" onclick="app.redo()">
      <span class="toolbar-btn-icon">‚Ü∑</span>
      <span>ÿ•ÿπÿßÿØÿ©</span>
    </button>
    <button class="toolbar-btn" onclick="app.clearCanvas()">
      <span class="toolbar-btn-icon">üóëÔ∏è</span>
    </button>
    <div style="width: 1px; height: 20px; background: rgba(148, 163, 184, 0.3);"></div>
    <button class="toolbar-btn" onclick="app.openSaveModal()">
      <span class="toolbar-btn-icon">üíæ</span>
      <span>ÿ≠ŸÅÿ∏</span>
    </button>
    <button class="toolbar-btn" onclick="app.openLoadModal()">
      <span class="toolbar-btn-icon">üìÅ</span>
    </button>
    <button class="toolbar-btn" onclick="app.openExportModal()">
      <span class="toolbar-btn-icon">üì§</span>
    </button>
  </div>

  <!-- Toggle Buttons -->
  <button class="toggle-btn" id="toggleTools" onclick="app.togglePanel('tools')">üõ†Ô∏è</button>
  <button class="toggle-btn" id="toggleColors" onclick="app.togglePanel('colors')">üé®</button>

  <!-- Tools Panel -->
  <div class="floating-panel" id="toolsPanel">
    <div class="panel-header">
      ÿßŸÑÿ£ÿØŸàÿßÿ™
      <button class="close-panel" onclick="app.closePanel('tools')">√ó</button>
    </div>
    <div class="tools-grid">
      <div class="tool-item active" onclick="app.setTool('pen')" data-tool="pen">
        <span class="tool-item-icon">‚úèÔ∏è</span>
        <span>ŸÇŸÑŸÖ</span>
      </div>
      <div class="tool-item" onclick="app.setTool('brush')" data-tool="brush">
        <span class="tool-item-icon">üñåÔ∏è</span>
        <span>ŸÅÿ±ÿ¥ÿßÿ©</span>
      </div>
      <div class="tool-item" onclick="app.setTool('eraser')" data-tool="eraser">
        <span class="tool-item-icon">üßπ</span>
        <span>ŸÖŸÖÿ≠ÿßÿ©</span>
      </div>
      <div class="tool-item" onclick="app.setTool('line')" data-tool="line">
        <span class="tool-item-icon">üìè</span>
        <span>ÿÆÿ∑</span>
      </div>
      <div class="tool-item" onclick="app.setTool('rectangle')" data-tool="rectangle">
        <span class="tool-item-icon">‚ñ≠</span>
        <span>ŸÖÿ±ÿ®ÿπ</span>
      </div>
      <div class="tool-item" onclick="app.setTool('circle')" data-tool="circle">
        <span class="tool-item-icon">‚≠ï</span>
        <span>ÿØÿßÿ¶ÿ±ÿ©</span>
      </div>
      <div class="tool-item" onclick="app.setTool('arrow')" data-tool="arrow">
        <span class="tool-item-icon">‚û°Ô∏è</span>
        <span>ÿ≥ŸáŸÖ</span>
      </div>
      <div class="tool-item" onclick="app.setTool('text')" data-tool="text">
        <span class="tool-item-icon">üìù</span>
        <span>ŸÜÿµ</span>
      </div>
    </div>
    <div class="section-divider"></div>
    <div class="panel-header" style="margin-top: 12px;">ÿ£ÿ¥ŸÉÿßŸÑ ÿ¨ÿßŸáÿ≤ÿ©</div>
    <div class="shapes-grid">
      <button class="shape-btn" onclick="app.insertShape('star')">‚≠ê</button>
      <button class="shape-btn" onclick="app.insertShape('heart')">‚ù§Ô∏è</button>
      <button class="shape-btn" onclick="app.insertShape('triangle')">üî∫</button>
      <button class="shape-btn" onclick="app.insertShape('hexagon')">‚¨°</button>
      <button class="shape-btn" onclick="app.insertShape('pentagon')">‚¨ü</button>
      <button class="shape-btn" onclick="app.insertShape('diamond')">üíé</button>
    </div>
    <div class="section-divider"></div>
    <button class="toolbar-btn" style="width: 100%; justify-content: center; margin-top: 8px;" onclick="app.importImage()">
      <span class="toolbar-btn-icon">üñºÔ∏è</span>
      <span>ÿßÿ≥ÿ™Ÿäÿ±ÿßÿØ ÿµŸàÿ±ÿ©</span>
    </button>
  </div>

  <!-- Colors Panel -->
  <div class="floating-panel" id="colorsPanel">
    <div class="panel-header">
      ÿßŸÑÿ£ŸÑŸàÿßŸÜ ŸàÿßŸÑÿ≠ÿ¨ŸÖ
      <button class="close-panel" onclick="app.closePanel('colors')">√ó</button>
    </div>
    <div class="color-grid" id="colorGrid"></div>
    <div class="custom-color-wrapper">
      <input type="color" class="custom-color-input" id="customColor" value="#000000" />
    </div>
    <div class="section-divider"></div>
    <div class="size-section">
      <label class="size-label">ÿ≠ÿ¨ŸÖ ÿßŸÑŸÅÿ±ÿ¥ÿßÿ©: <span id="brushSizeLabel">3</span>px</label>
      <input type="range" class="size-slider" id="brushSize" min="1" max="50" value="3" />
      <div class="size-preview">
        <div id="sizePreviewDot" class="size-preview-dot"></div>
      </div>
    </div>
  </div>

  <!-- Status Bar -->
  <div class="status-bar">
    <span>ÿßŸÑÿ£ÿØÿßÿ©: <span id="toolStatus">pen</span></span>
    <span class="status-divider"></span>
    <span id="historyInfo">1 / 1</span>
  </div>

  <!-- Save Modal -->
  <div class="modal" id="saveModal">
    <div class="modal-content">
      <h2 class="modal-header">üíæ ÿ≠ŸÅÿ∏ ÿßŸÑÿ±ÿ≥ŸÖÿ©</h2>
      <div class="form-group">
        <label class="form-label">ÿßÿ≥ŸÖ ÿßŸÑÿ±ÿ≥ŸÖÿ©</label>
        <input type="text" class="form-input" id="saveName" placeholder="ÿ£ÿØÿÆŸÑ ÿßÿ≥ŸÖ ÿßŸÑÿ±ÿ≥ŸÖÿ©..." />
      </div>
      <div class="form-group">
        <label class="form-label">ÿßŸÑŸÖÿ¨ŸÑÿØ (ÿßÿÆÿ™Ÿäÿßÿ±Ÿä)</label>
        <input type="text" class="form-input" id="saveFolder" placeholder="ŸÖÿ´ÿßŸÑ: ÿ±ÿ≥ŸàŸÖÿßÿ™Ÿä" />
      </div>
      <div class="modal-actions">
        <button class="btn btn-secondary" onclick="app.closeSaveModal()">ÿ•ŸÑÿ∫ÿßÿ°</button>
        <button class="btn btn-primary" onclick="app.saveDrawing()">ÿ≠ŸÅÿ∏</button>
      </div>
    </div>
  </div>

  <!-- Load Modal -->
  <div class="modal" id="loadModal">
    <div class="modal-content">
      <h2 class="modal-header">üìÅ ŸÅÿ™ÿ≠ ÿ±ÿ≥ŸÖÿ©</h2>
      <div class="files-list" id="filesList"></div>
      <div class="modal-actions">
        <button class="btn btn-secondary" onclick="app.closeLoadModal()">ÿ•ÿ∫ŸÑÿßŸÇ</button>
      </div>
    </div>
  </div>

  <!-- Export Modal -->
  <div class="modal" id="exportModal">
    <div class="modal-content">
      <h2 class="modal-header">üì§ ÿ™ÿµÿØŸäÿ± ÿßŸÑÿ±ÿ≥ŸÖÿ©</h2>
      <div style="display: flex; flex-direction: column; gap: 10px;">
        <button class="btn btn-primary" onclick="app.exportAsPNG()">ÿ™ÿµÿØŸäÿ± ŸÉŸÄ PNG</button>
        <button class="btn btn-primary" onclick="app.exportAsJPG()">ÿ™ÿµÿØŸäÿ± ŸÉŸÄ JPG</button>
        <button class="btn btn-primary" onclick="app.exportAsPDF()">ÿ™ÿµÿØŸäÿ± ŸÉŸÄ PDF</button>
        <button class="btn btn-secondary" onclick="app.closeExportModal()">ÿ•ŸÑÿ∫ÿßÿ°</button>
      </div>
    </div>
  </div>

  <!-- Hidden file input -->
  <input type="file" id="imageUpload" accept="image/*" />

  <!-- jsPDF for PDF export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <script>
    // Drawing Application
    const app = {
      currentTool: 'pen',
      currentColor: '#000000',
      brushSize: 3,
      isDrawing: false,
      startX: 0,
      startY: 0,
      history: [],
      historyIndex: -1,
      lastSaved: null,

      colors: [
        '#000000', '#FFFFFF', '#FF0000', '#00FF00', '#0000FF', '#FFFF00',
        '#FF00FF', '#00FFFF', '#FFA500', '#800080', '#008000', '#800000',
        '#808080', '#C0C0C0', '#FFB6C1', '#87CEEB', '#90EE90', '#DDA0DD'
      ],

      init() {
        this.canvas = document.getElementById('drawingCanvas');
        this.ctx = this.canvas.getContext('2d');

        // Set canvas size to window size
        this.resizeCanvas();
        window.addEventListener('resize', () => this.resizeCanvas());

        this.ctx.lineCap = 'round';
        this.ctx.lineJoin = 'round';

        this.saveState();
        this.setupEventListeners();
        this.renderColors();
        this.updateUI();

        console.log('üé® Drawing board ready!');
      },

      resizeCanvas() {
        const oldData = this.canvas.toDataURL();
        this.canvas.width = window.innerWidth;
        this.canvas.height = window.innerHeight;

        // Restore content after resize
        if (oldData) {
          const img = new Image();
          img.onload = () => {
            this.ctx.drawImage(img, 0, 0);
          };
          img.src = oldData;
        } else {
          this.ctx.fillStyle = 'white';
          this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
        }
      },

      setupEventListeners() {
        this.canvas.addEventListener('mousedown', (e) => this.startDrawing(e));
        this.canvas.addEventListener('mousemove', (e) => this.draw(e));
        this.canvas.addEventListener('mouseup', (e) => this.stopDrawing(e));
        this.canvas.addEventListener('mouseout', () => this.stopDrawing());

        this.canvas.addEventListener('touchstart', (e) => this.handleTouch(e, 'start'));
        this.canvas.addEventListener('touchmove', (e) => this.handleTouch(e, 'move'));
        this.canvas.addEventListener('touchend', () => this.stopDrawing());

        document.getElementById('customColor').addEventListener('input', (e) => {
          this.currentColor = e.target.value;
          this.updateUI();
        });

        document.getElementById('brushSize').addEventListener('input', (e) => {
          this.brushSize = parseInt(e.target.value);
          this.updateUI();
        });

        document.getElementById('imageUpload').addEventListener('change', (e) => this.handleImageUpload(e));

        // Close modals on outside click
        ['saveModal', 'loadModal', 'exportModal'].forEach(id => {
          const modal = document.getElementById(id);
          modal.addEventListener('click', (e) => {
            if (e.target === modal) {
              modal.classList.remove('active');
            }
          });
        });
      },

      togglePanel(panelName) {
        const panel = document.getElementById(panelName + 'Panel');
        const otherPanel = panelName === 'tools' ? document.getElementById('colorsPanel') : document.getElementById('toolsPanel');

        if (panel.classList.contains('show')) {
          panel.classList.remove('show');
        } else {
          otherPanel.classList.remove('show');
          panel.classList.add('show');
        }
      },

      closePanel(panelName) {
        document.getElementById(panelName + 'Panel').classList.remove('show');
      },

      renderColors() {
        const grid = document.getElementById('colorGrid');
        grid.innerHTML = '';
        this.colors.forEach(color => {
          const swatch = document.createElement('div');
          swatch.className = 'color-swatch';
          swatch.style.backgroundColor = color;
          if (color === this.currentColor) swatch.classList.add('active');
          swatch.addEventListener('click', () => {
            this.currentColor = color;
            document.getElementById('customColor').value = color;
            this.updateUI();
            this.renderColors();
          });
          grid.appendChild(swatch);
        });
      },

      updateUI() {
        document.getElementById('brushSizeLabel').textContent = this.brushSize;
        document.getElementById('toolStatus').textContent = this.currentTool;
        document.getElementById('historyInfo').textContent = `${this.historyIndex + 1} / ${this.history.length}`;

        const dot = document.getElementById('sizePreviewDot');
        dot.style.width = this.brushSize + 'px';
        dot.style.height = this.brushSize + 'px';
        dot.style.backgroundColor = this.currentColor;

        document.querySelectorAll('.tool-item').forEach(item => {
          item.classList.remove('active');
          if (item.dataset.tool === this.currentTool) {
            item.classList.add('active');
          }
        });
      },

      handleTouch(e, type) {
        e.preventDefault();
        const touch = e.touches[0];
        if (touch) {
          const mouseEvent = new MouseEvent(
            type === 'start' ? 'mousedown' : 'mousemove',
            { clientX: touch.clientX, clientY: touch.clientY }
          );
          this.canvas.dispatchEvent(mouseEvent);
        }
      },

      getMousePos(e) {
        const rect = this.canvas.getBoundingClientRect();
        return {
          x: e.clientX - rect.left,
          y: e.clientY - rect.top
        };
      },

      startDrawing(e) {
        this.isDrawing = true;
        const pos = this.getMousePos(e);
        this.startX = pos.x;
        this.startY = pos.y;

        if (this.currentTool === 'pen' || this.currentTool === 'brush') {
          this.ctx.beginPath();
          this.ctx.moveTo(pos.x, pos.y);
        } else if (this.currentTool === 'text') {
          this.drawText(pos.x, pos.y);
          this.isDrawing = false;
          this.saveState();
        }
      },

      draw(e) {
        if (!this.isDrawing) return;
        const pos = this.getMousePos(e);

        if (this.currentTool === 'pen' || this.currentTool === 'brush') {
          this.ctx.strokeStyle = this.currentColor;
          this.ctx.lineWidth = this.currentTool === 'brush' ? this.brushSize * 2 : this.brushSize;
          this.ctx.lineTo(pos.x, pos.y);
          this.ctx.stroke();
        } else if (this.currentTool === 'eraser') {
          this.ctx.clearRect(pos.x - this.brushSize, pos.y - this.brushSize, this.brushSize * 2, this.brushSize * 2);
        }
      },

      stopDrawing(e) {
        if (!this.isDrawing) return;

        if (e) {
          const pos = this.getMousePos(e);
          if (this.currentTool === 'line') this.drawLine(this.startX, this.startY, pos.x, pos.y);
          else if (this.currentTool === 'rectangle') this.drawRectangle(this.startX, this.startY, pos.x, pos.y);
          else if (this.currentTool === 'circle') this.drawCircle(this.startX, this.startY, pos.x, pos.y);
          else if (this.currentTool === 'arrow') this.drawArrow(this.startX, this.startY, pos.x, pos.y);
        }

        this.isDrawing = false;
        this.saveState();
      },

      drawLine(x1, y1, x2, y2) {
        this.ctx.strokeStyle = this.currentColor;
        this.ctx.lineWidth = this.brushSize;
        this.ctx.beginPath();
        this.ctx.moveTo(x1, y1);
        this.ctx.lineTo(x2, y2);
        this.ctx.stroke();
      },

      drawRectangle(x1, y1, x2, y2) {
        this.ctx.strokeStyle = this.currentColor;
        this.ctx.lineWidth = this.brushSize;
        this.ctx.strokeRect(x1, y1, x2 - x1, y2 - y1);
      },

      drawCircle(x1, y1, x2, y2) {
        const radius = Math.sqrt(Math.pow(x2 - x1, 2) + Math.pow(y2 - y1, 2));
        this.ctx.strokeStyle = this.currentColor;
        this.ctx.lineWidth = this.brushSize;
        this.ctx.beginPath();
        this.ctx.arc(x1, y1, radius, 0, 2 * Math.PI);
        this.ctx.stroke();
      },

      drawArrow(x1, y1, x2, y2) {
        const headlen = 15;
        const angle = Math.atan2(y2 - y1, x2 - x1);
        this.ctx.strokeStyle = this.currentColor;
        this.ctx.lineWidth = this.brushSize;

        this.ctx.beginPath();
        this.ctx.moveTo(x1, y1);
        this.ctx.lineTo(x2, y2);
        this.ctx.stroke();

        this.ctx.beginPath();
        this.ctx.moveTo(x2, y2);
        this.ctx.lineTo(x2 - headlen * Math.cos(angle - Math.PI / 6), y2 - headlen * Math.sin(angle - Math.PI / 6));
        this.ctx.moveTo(x2, y2);
        this.ctx.lineTo(x2 - headlen * Math.cos(angle + Math.PI / 6), y2 - headlen * Math.sin(angle + Math.PI / 6));
        this.ctx.stroke();
      },

      drawText(x, y) {
        const text = prompt('ÿ£ÿØÿÆŸÑ ÿßŸÑŸÜÿµ:');
        if (text) {
          this.ctx.fillStyle = this.currentColor;
          this.ctx.font = (this.brushSize * 5) + 'px Arial';
          this.ctx.fillText(text, x, y);
        }
      },

      insertShape(shape) {
        const centerX = this.canvas.width / 2;
        const centerY = this.canvas.height / 2;
        const size = 50;

        this.ctx.fillStyle = this.currentColor;
        this.ctx.strokeStyle = this.currentColor;
        this.ctx.lineWidth = this.brushSize;

        switch(shape) {
          case 'star': this.drawStar(centerX, centerY, 5, size, size/2); break;
          case 'heart': this.drawHeart(centerX, centerY, size); break;
          case 'triangle': this.drawTriangle(centerX, centerY, size); break;
          case 'hexagon': this.drawPolygon(centerX, centerY, 6, size); break;
          case 'pentagon': this.drawPolygon(centerX, centerY, 5, size); break;
          case 'diamond': this.drawDiamond(centerX, centerY, size); break;
        }

        this.saveState();
      },

      drawStar(cx, cy, spikes, outerRadius, innerRadius) {
        let rot = Math.PI / 2 * 3;
        const step = Math.PI / spikes;
        this.ctx.beginPath();
        this.ctx.moveTo(cx, cy - outerRadius);

        for (let i = 0; i < spikes; i++) {
          let x = cx + Math.cos(rot) * outerRadius;
          let y = cy + Math.sin(rot) * outerRadius;
          this.ctx.lineTo(x, y);
          rot += step;
          x = cx + Math.cos(rot) * innerRadius;
          y = cy + Math.sin(rot) * innerRadius;
          this.ctx.lineTo(x, y);
          rot += step;
        }

        this.ctx.lineTo(cx, cy - outerRadius);
        this.ctx.closePath();
        this.ctx.stroke();
      },

      drawHeart(cx, cy, size) {
        this.ctx.beginPath();
        const topCurveHeight = size * 0.3;
        this.ctx.moveTo(cx, cy + topCurveHeight);
        this.ctx.bezierCurveTo(cx, cy, cx - size / 2, cy - size / 2, cx - size / 2, cy + topCurveHeight);
        this.ctx.bezierCurveTo(cx - size / 2, cy + (size + topCurveHeight) / 2, cx, cy + (size + topCurveHeight) / 2, cx, cy + size);
        this.ctx.bezierCurveTo(cx, cy + (size + topCurveHeight) / 2, cx + size / 2, cy + (size + topCurveHeight) / 2, cx + size / 2, cy + topCurveHeight);
        this.ctx.bezierCurveTo(cx + size / 2, cy - size / 2, cx, cy, cx, cy + topCurveHeight);
        this.ctx.closePath();
        this.ctx.stroke();
      },

      drawTriangle(cx, cy, size) {
        this.ctx.beginPath();
        this.ctx.moveTo(cx, cy - size);
        this.ctx.lineTo(cx - size, cy + size);
        this.ctx.lineTo(cx + size, cy + size);
        this.ctx.closePath();
        this.ctx.stroke();
      },

      drawPolygon(cx, cy, sides, size) {
        this.ctx.beginPath();
        for (let i = 0; i < sides; i++) {
          const angle = (i * 2 * Math.PI) / sides - Math.PI / 2;
          const x = cx + size * Math.cos(angle);
          const y = cy + size * Math.sin(angle);
          if (i === 0) this.ctx.moveTo(x, y);
          else this.ctx.lineTo(x, y);
        }
        this.ctx.closePath();
        this.ctx.stroke();
      },

      drawDiamond(cx, cy, size) {
        this.ctx.beginPath();
        this.ctx.moveTo(cx, cy - size);
        this.ctx.lineTo(cx + size, cy);
        this.ctx.lineTo(cx, cy + size);
        this.ctx.lineTo(cx - size, cy);
        this.ctx.closePath();
        this.ctx.stroke();
      },

      setTool(tool) {
        this.currentTool = tool;
        this.updateUI();
      },

      saveState() {
        this.history = this.history.slice(0, this.historyIndex + 1);
        this.history.push(this.canvas.toDataURL());
        this.historyIndex++;
        if (this.history.length > 50) {
          this.history.shift();
          this.historyIndex--;
        }
        this.updateUI();
      },

      restoreState(index) {
        const img = new Image();
        img.src = this.history[index];
        img.onload = () => {
          this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
          this.ctx.drawImage(img, 0, 0);
        };
      },

      undo() {
        if (this.historyIndex > 0) {
          this.historyIndex--;
          this.restoreState(this.historyIndex);
          this.updateUI();
        }
      },

      redo() {
        if (this.historyIndex < this.history.length - 1) {
          this.historyIndex++;
          this.restoreState(this.historyIndex);
          this.updateUI();
        }
      },

      clearCanvas() {
        if (confirm('ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ŸÖÿ≥ÿ≠ ÿßŸÑŸÑŸàÿ≠ÿ©ÿü')) {
          this.ctx.fillStyle = 'white';
          this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
          this.saveState();
        }
      },

      importImage() {
        document.getElementById('imageUpload').click();
      },

      handleImageUpload(e) {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = (event) => {
            const img = new Image();
            img.onload = () => {
              this.ctx.drawImage(img, 0, 0);
              this.saveState();
            };
            img.src = event.target.result;
          };
          reader.readAsDataURL(file);
        }
      },

      openSaveModal() {
        document.getElementById('saveModal').classList.add('active');
      },

      closeSaveModal() {
        document.getElementById('saveModal').classList.remove('active');
        document.getElementById('saveName').value = '';
        document.getElementById('saveFolder').value = '';
      },

      openLoadModal() {
        document.getElementById('loadModal').classList.add('active');
        this.loadSavedFiles();
      },

      closeLoadModal() {
        document.getElementById('loadModal').classList.remove('active');
      },

      openExportModal() {
        document.getElementById('exportModal').classList.add('active');
      },

      closeExportModal() {
        document.getElementById('exportModal').classList.remove('active');
      },

      saveDrawing() {
        const name = document.getElementById('saveName').value.trim();
        const folder = document.getElementById('saveFolder').value.trim();

        if (!name) {
          alert('ÿßŸÑÿ±ÿ¨ÿßÿ° ÿ•ÿØÿÆÿßŸÑ ÿßÿ≥ŸÖ ŸÑŸÑÿ±ÿ≥ŸÖÿ©');
          return;
        }

        const drawing = {
          id: Date.now(),
          name: name,
          folder: folder,
          data: this.canvas.toDataURL(),
          date: new Date().toLocaleDateString('ar-SA')
        };

        let drawings = JSON.parse(localStorage.getItem('drawings') || '[]');
        drawings.push(drawing);
        localStorage.setItem('drawings', JSON.stringify(drawings));

        this.lastSaved = drawing.date;
        this.closeSaveModal();
        alert('ÿ™ŸÖ ÿßŸÑÿ≠ŸÅÿ∏ ÿ®ŸÜÿ¨ÿßÿ≠!');
      },

      loadSavedFiles() {
        const drawings = JSON.parse(localStorage.getItem('drawings') || '[]');
        const list = document.getElementById('filesList');

        if (drawings.length === 0) {
          list.innerHTML = '<div style="text-align: center; padding: 2rem; color: rgba(148, 163, 184, 0.8);">ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ±ÿ≥ŸàŸÖÿßÿ™ ŸÖÿ≠ŸÅŸàÿ∏ÿ©</div>';
          return;
        }

        list.innerHTML = '';
        drawings.reverse().forEach(drawing => {
          const item = document.createElement('div');
          item.className = 'file-item';
          item.innerHTML = `
            <div class="file-info">
              <div class="file-name">${drawing.name}</div>
              <div class="file-meta">${drawing.folder || 'ÿ®ÿØŸàŸÜ ŸÖÿ¨ŸÑÿØ'} ‚Ä¢ ${drawing.date}</div>
            </div>
            <div class="file-actions">
              <button class="btn-small" onclick="app.deleteDrawing(${drawing.id}); event.stopPropagation();">üóëÔ∏è</button>
            </div>
          `;
          item.addEventListener('click', () => this.loadDrawing(drawing.id));
          list.appendChild(item);
        });
      },

      loadDrawing(id) {
        const drawings = JSON.parse(localStorage.getItem('drawings') || '[]');
        const drawing = drawings.find(d => d.id === id);

        if (drawing) {
          const img = new Image();
          img.onload = () => {
            this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
            this.ctx.drawImage(img, 0, 0);
            this.saveState();
            this.closeLoadModal();
          };
          img.src = drawing.data;
        }
      },

      deleteDrawing(id) {
        if (confirm('ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ≠ÿ∞ŸÅ Ÿáÿ∞Ÿá ÿßŸÑÿ±ÿ≥ŸÖÿ©ÿü')) {
          let drawings = JSON.parse(localStorage.getItem('drawings') || '[]');
          drawings = drawings.filter(d => d.id !== id);
          localStorage.setItem('drawings', JSON.stringify(drawings));
          this.loadSavedFiles();
        }
      },

      exportAsPNG() {
        const link = document.createElement('a');
        const name = document.getElementById('saveName').value.trim() || 'drawing';
        link.download = name + '.png';
        link.href = this.canvas.toDataURL();
        link.click();
        this.closeExportModal();
      },

      exportAsJPG() {
        const link = document.createElement('a');
        const name = document.getElementById('saveName').value.trim() || 'drawing';
        link.download = name + '.jpg';
        link.href = this.canvas.toDataURL('image/jpeg');
        link.click();
        this.closeExportModal();
      },

      exportAsPDF() {
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF({
          orientation: 'landscape',
          unit: 'px',
          format: [this.canvas.width, this.canvas.height]
        });

        const name = document.getElementById('saveName').value.trim() || 'drawing';
        pdf.addImage(this.canvas.toDataURL(), 'PNG', 0, 0, this.canvas.width, this.canvas.height);
        pdf.save(name + '.pdf');
        this.closeExportModal();
      }
    };

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => app.init());
    } else {
      app.init();
    }
  </script>
</body>
</html>
