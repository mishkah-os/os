<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
  <title> — نقطة البيع للمطاعم</title>
  <style>
    :root { color-scheme: light dark; }
    html, body {
      height: 100%;
      min-height: 100vh;
      width: 100vw;
      margin: 0;
      overflow: hidden;
      background: var(--background, #0f1115);
    }
    body {
      font-family: "Tajawal", "Cairo", system-ui, sans-serif;
      touch-action: manipulation;
      display: flex;
      min-height: 100vh;
      width: 100vw;
    }
    #app {
      flex: 1 1 auto;
      min-height: 100vh;
      width: 100vw;
      display: flex;
    }
    .pos-shell { flex: 1 1 auto; width: 100vw; }
  </style>
  <script src="../lib/mishkah-utils.js"></script>
  <script src="../lib/mishkah.core.js"></script>
  <script src="../lib/mishkah-ui.js"></script>
  <script src="../lib/mishkah-schema.js"></script>
    <script src="../lib/mishkah.store.js"></script>
  <script src="../lib/mishkah.simple-store.js"></script>
  <script src="./pos-mini-db.js"></script>
</head>
<body>
  <div id="app"></div>
  <script>
    let createPosDb = window.createPosDb;

    const params = new URLSearchParams(window.location.search || '');
    const BRANCH_ID = (params.get('brname') || '').trim();
    if (BRANCH_ID) {
      window.__POS_BRANCH_ID__ = BRANCH_ID;
    }

    if (!BRANCH_ID) {
      document.body.innerHTML = `
        <main
          style="
            min-height: 100vh;
            display: grid;
            place-items: center;
            font-size: clamp(1.4rem, 4vw, 2.2rem);
            color: #f8fafc;
              text-align:center;
          "
        >
        
          يرجى اختيار الفرع
        </main>
      `;
    } else {

      const status = {
        status: 'loading',
        startedAt: Date.now(),
        finishedAt: null,
        error: null,
        keys: [],
        branchId: BRANCH_ID
      };

      window.__POS_DATA_STATUS__ = status;

      createPosDb({ branchId: BRANCH_ID })
        .then(({ db, moduleEntry }) => {
          window.__POS_DB__ = db;
          window.__POS_MODULE_ENTRY__ = moduleEntry;
          return db.ready();
        })
        .then(() => {
          const db = window.__POS_DB__;

          // Function to update window.database from all registered tables
          const updateWindowDatabase = () => {
            console.log('[POS] Building window.database from direct table access');
            let payload = {};

            // Check if db has snapshot method (offline store)
            if (typeof db.snapshot === 'function') {
              console.log('[POS] Using db.snapshot() (offline mode)');
              const snapshot = db.snapshot();
              payload = snapshot.tables || {};
              console.log('[POS] Snapshot tables:', Object.keys(payload).length, 'tables');
            } else {
              // WebSocket store: build from registered objects using db.list()
              console.log('[POS] Using db.list() for each table (WebSocket mode)');

              // Get registered names from the store (not from config!)
              const registeredNames = typeof db.getRegisteredNames === 'function'
                ? db.getRegisteredNames()
                : Object.keys(db.config?.objects || {});

              console.log('[POS] Registered names:', registeredNames);

              registeredNames.forEach(name => {
                try {
                  // Skip pos_database - we don't need it anymore
                  if (name === 'pos_database') {
                    console.log('[POS] Skipping pos_database (deprecated)');
                    return;
                  }

                  // Get definition to find table name
                  const def = typeof db.getDefinition === 'function' ? db.getDefinition(name) : null;
                  const tableName = def?.table || name;

                  const data = db.list(name);
                  payload[tableName] = data || [];

                  if (data && data.length > 0) {
                    console.log(`[POS] ✓ ${name} (table: ${tableName}): ${data.length} records`);
                  }
                } catch (err) {
                  console.warn(`[POS] ✗ Failed to list ${name}:`, err);
                }
              });

              console.log('[POS] Final payload:', Object.keys(payload).length, 'tables with data');
            }

            const previousKeys = Object.keys(window.database || {}).sort().join(',');
            const newKeys = Object.keys(payload || {}).sort().join(',');

            window.database = payload;
            status.status = Object.keys(payload).length > 0 ? 'ready' : 'idle';
            status.keys = Object.keys(payload || {});

            // Log update if keys changed
            if (previousKeys !== newKeys) {
              console.log('[POS] window.database updated with new data', {
                previousKeyCount: previousKeys.split(',').filter(Boolean).length,
                newKeyCount: newKeys.split(',').filter(Boolean).length,
                keys: Object.keys(payload),
                timestamp: new Date().toISOString()
              });
            }

            // Always log final state for debugging
            const tablesWithData = Object.keys(window.database).filter(k => window.database[k]?.length > 0);
            console.log('[POS] window.database ready:', {
              totalTables: tablesWithData.length,
              tables: tablesWithData.map(k => ({ name: k, count: window.database[k]?.length || 0 })),
              status: status.status
            });
          };

          // Initial load
          updateWindowDatabase();
          status.finishedAt = Date.now();

          // Watch for changes in ALL registered tables (not just pos_database)
          const registeredNames = typeof db.getRegisteredNames === 'function'
            ? db.getRegisteredNames()
            : Object.keys(db.config?.objects || {});

          registeredNames.forEach(name => {
            if (name === 'pos_database') return; // Skip deprecated table

            db.watch(name, (records) => {
              console.log(`[POS] ${name} changed (${records.length} records), updating window.database...`);
              updateWindowDatabase();
            });
          });

          // POLLING: Check REST API for updates every 30 seconds
          let lastChecksum = null;
          const checkForUpdates = async () => {
            try {
              const response = await fetch(`/api/branches/${BRANCH_ID}/modules/pos`, {
                cache: 'no-store',
                headers: { 'Cache-Control': 'no-cache, no-store, must-revalidate' }
              });

              if (!response.ok) return;

              const data = await response.json();
              const newChecksum = JSON.stringify(data).substring(0, 200);

              if (lastChecksum === null) {
                lastChecksum = newChecksum;
                return;
              }

              if (newChecksum !== lastChecksum) {
                console.log('[POS] Data changed via REST API! Reloading page...');
                lastChecksum = newChecksum;
                window.location.reload();
              }
            } catch (error) {
              console.warn('[POS] Polling check failed:', error);
            }
          };

          // Check immediately and then every 30 seconds
          checkForUpdates();
          setInterval(checkForUpdates, 30000);

          const script = document.createElement('script');
          script.src = './pos.js';
          document.head.appendChild(script);
        })
        .catch((error) => {
          console.error('[POS] Failed to hydrate dataset from /api/schema', error);
          window.database = {};
          status.status = 'error';
          status.error = error;
          status.finishedAt = Date.now();
        });
    }
  </script>
</body>
</html>
