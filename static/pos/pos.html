<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
  <title> — نقطة البيع للمطاعم</title>
  <style>
    :root { color-scheme: light dark; }
    html, body {
      height: 100%;
      min-height: 100vh;
      width: 100vw;
      margin: 0;
      overflow: hidden;
      background: var(--background, #0f1115);
    }
    body {
      font-family: "Tajawal", "Cairo", system-ui, sans-serif;
      touch-action: manipulation;
      display: flex;
      min-height: 100vh;
      width: 100vw;
    }
    #app {
      flex: 1 1 auto;
      min-height: 100vh;
      width: 100vw;
      display: flex;
    }
    .pos-shell { flex: 1 1 auto; width: 100vw; }
  </style>
  <script src="../lib/mishkah-utils.js"></script>
  <script src="../lib/mishkah.core.js"></script>
  <script src="../lib/mishkah-ui.js"></script>
  <script src="../lib/mishkah-schema.js"></script>
    <script src="../lib/mishkah.store.js"></script>
  <script src="../lib/mishkah.simple-store.js"></script>
  <script src="./pos-mini-db.js"></script>
</head>
<body>
  <div id="app"></div>
  <script>
    let createPosDb = window.createPosDb;

    const params = new URLSearchParams(window.location.search || '');
    const BRANCH_ID = (params.get('brname') || '').trim();
    if (BRANCH_ID) {
      window.__POS_BRANCH_ID__ = BRANCH_ID;
    }

    if (!BRANCH_ID) {
      document.body.innerHTML = `
        <main
          style="
            min-height: 100vh;
            display: grid;
            place-items: center;
            font-size: clamp(1.4rem, 4vw, 2.2rem);
            color: #f8fafc;
              text-align:center;
          "
        >
        
          يرجى اختيار الفرع
        </main>
      `;
    } else {

      const status = {
        status: 'loading',
        startedAt: Date.now(),
        finishedAt: null,
        error: null,
        keys: [],
        branchId: BRANCH_ID
      };

      window.__POS_DATA_STATUS__ = status;

      createPosDb({ branchId: BRANCH_ID })
        .then(({ db, moduleEntry }) => {
          window.__POS_DB__ = db;
          window.__POS_MODULE_ENTRY__ = moduleEntry;
          return db.ready();
        })
        .then(() => {
          const db = window.__POS_DB__;

          // Function to update window.database from latest record
          const updateWindowDatabase = () => {
            const records = db.list('pos_database');
            const latest = Array.isArray(records) && records.length ? records[records.length - 1] : null;
            const payload = latest && latest.payload ? latest.payload : {};
            const previousKeys = Object.keys(window.database || {}).sort().join(',');
            const newKeys = Object.keys(payload || {}).sort().join(',');

            window.database = payload;
            status.status = latest ? 'ready' : 'idle';
            status.keys = Object.keys(payload || {});

            // Log update if keys changed
            if (previousKeys !== newKeys) {
              console.log('[POS] window.database updated with new data', {
                previousKeyCount: previousKeys.split(',').filter(Boolean).length,
                newKeyCount: newKeys.split(',').filter(Boolean).length,
                timestamp: new Date().toISOString()
              });
            }
          };

          // Initial load
          updateWindowDatabase();
          status.finishedAt = Date.now();

          // Watch for changes to pos_database
          db.watch('pos_database', (records) => {
            console.log('[POS] pos_database changed, updating window.database...', {
              recordCount: records.length,
              timestamp: new Date().toISOString()
            });
            updateWindowDatabase();
          });

          // POLLING: Check live/data.json for updates every 30 seconds
          let lastChecksum = null;
          const checkForUpdates = async () => {
            try {
              const response = await fetch(`/data/branches/${BRANCH_ID}/modules/pos/live/data.json`, {
                cache: 'no-store',
                headers: { 'Cache-Control': 'no-cache, no-store, must-revalidate' }
              });

              if (!response.ok) return;

              const data = await response.json();
              const newChecksum = JSON.stringify(data).substring(0, 200);

              if (lastChecksum === null) {
                lastChecksum = newChecksum;
                return;
              }

              if (newChecksum !== lastChecksum) {
                console.log('[POS] live/data.json changed! Reloading page...');
                lastChecksum = newChecksum;
                window.location.reload();
              }
            } catch (error) {
              console.warn('[POS] Polling check failed:', error);
            }
          };

          // Check immediately and then every 30 seconds
          checkForUpdates();
          setInterval(checkForUpdates, 30000);

          const script = document.createElement('script');
          script.src = './pos.js';
          document.head.appendChild(script);
        })
        .catch((error) => {
          console.error('[POS] Failed to hydrate dataset from /api/schema', error);
          window.database = {};
          status.status = 'error';
          status.error = error;
          status.finishedAt = Date.now();
        });
    }
  </script>
</body>
</html>
