<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… ERP - Ù…Ø±ÙƒØ² Ø§Ù„Ø¹Ù„Ø§Ø¬ Ø§Ù„Ø·Ø¨ÙŠØ¹ÙŠ | ERP Dashboard - Physical Therapy Center</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Custom Styles -->
  <link rel="stylesheet" href="css/custom-styles.css">

  <!-- Load Mishkah Libraries -->
  <script src="../../lib/mishkah-utils.js"></script>
  <script src="../../lib/mishkah.core.js"></script>
  <script src="../../lib/mishkah-ui.js"></script>
</head>
<body>
  <div id="app"></div>

  <script>
    (async function() {
      const M = Mishkah;
      const D = M.DSL;
      const UI = M.UI;
      const { tw, token } = M.utils.twcss;

      // Application State
      const db = {
        env: {
          lang: 'ar',
          dir: 'rtl',
          theme: 'light'
        },
        data: {
          currentPage: 'dashboard',
          showModal: false,
          modalType: null,
          patients: [
            { id: 1, name: 'Ø£Ø­Ù…Ø¯ Ù…Ø­Ù…Ø¯', phone: '01012345678', status: 'active', lastVisit: '2024-01-15', totalSessions: 12 },
            { id: 2, name: 'ÙØ§Ø·Ù…Ø© Ø¹Ù„ÙŠ', phone: '01023456789', status: 'active', lastVisit: '2024-01-14', totalSessions: 8 },
            { id: 3, name: 'Ù…Ø­Ù…ÙˆØ¯ Ø³Ø§Ù„Ù…', phone: '01034567890', status: 'completed', lastVisit: '2024-01-10', totalSessions: 15 }
          ],
          appointments: [
            { id: 1, patientName: 'Ø£Ø­Ù…Ø¯ Ù…Ø­Ù…Ø¯', date: '2024-01-16', time: '10:00', service: 'Ø¹Ù„Ø§Ø¬ Ø·Ø¨ÙŠØ¹ÙŠ Ù„Ù„Ø¸Ù‡Ø±', status: 'confirmed' },
            { id: 2, patientName: 'ÙØ§Ø·Ù…Ø© Ø¹Ù„ÙŠ', date: '2024-01-16', time: '11:00', service: 'Ø¹Ù„Ø§Ø¬ Ø§Ù„Ù…ÙØ§ØµÙ„', status: 'pending' },
            { id: 3, patientName: 'Ù…Ø­Ù…ÙˆØ¯ Ø³Ø§Ù„Ù…', date: '2024-01-16', time: '14:00', service: 'Ø¹Ù„Ø§Ø¬ Ø±ÙŠØ§Ø¶ÙŠ', status: 'confirmed' }
          ],
          stats: {
            totalPatients: 145,
            todayAppointments: 12,
            completedSessions: 1250,
            revenue: 125000
          }
        },
        i18n: {
          dict: {
            'dashboard': { ar: 'Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…', en: 'Dashboard' },
            'patients': { ar: 'Ø§Ù„Ù…Ø±Ø¶Ù‰', en: 'Patients' },
            'appointments': { ar: 'Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯', en: 'Appointments' },
            'sessions': { ar: 'Ø§Ù„Ø¬Ù„Ø³Ø§Øª', en: 'Sessions' },
            'reports': { ar: 'Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±', en: 'Reports' },
            'settings': { ar: 'Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª', en: 'Settings' },
            'totalPatients': { ar: 'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø±Ø¶Ù‰', en: 'Total Patients' },
            'todayAppointments': { ar: 'Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø§Ù„ÙŠÙˆÙ…', en: "Today's Appointments" },
            'completedSessions': { ar: 'Ø§Ù„Ø¬Ù„Ø³Ø§Øª Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø©', en: 'Completed Sessions' },
            'revenue': { ar: 'Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª', en: 'Revenue' },
            'recentPatients': { ar: 'Ø§Ù„Ù…Ø±Ø¶Ù‰ Ø§Ù„Ø£Ø®ÙŠØ±ÙˆÙ†', en: 'Recent Patients' },
            'upcomingAppointments': { ar: 'Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©', en: 'Upcoming Appointments' },
            'addNew': { ar: 'Ø¥Ø¶Ø§ÙØ© Ø¬Ø¯ÙŠØ¯', en: 'Add New' },
            'name': { ar: 'Ø§Ù„Ø§Ø³Ù…', en: 'Name' },
            'phone': { ar: 'Ø§Ù„Ù‡Ø§ØªÙ', en: 'Phone' },
            'status': { ar: 'Ø§Ù„Ø­Ø§Ù„Ø©', en: 'Status' },
            'lastVisit': { ar: 'Ø¢Ø®Ø± Ø²ÙŠØ§Ø±Ø©', en: 'Last Visit' },
            'patient': { ar: 'Ø§Ù„Ù…Ø±ÙŠØ¶', en: 'Patient' },
            'date': { ar: 'Ø§Ù„ØªØ§Ø±ÙŠØ®', en: 'Date' },
            'time': { ar: 'Ø§Ù„ÙˆÙ‚Øª', en: 'Time' },
            'service': { ar: 'Ø§Ù„Ø®Ø¯Ù…Ø©', en: 'Service' },
            'active': { ar: 'Ù†Ø´Ø·', en: 'Active' },
            'completed': { ar: 'Ù…ÙƒØªÙ…Ù„', en: 'Completed' },
            'confirmed': { ar: 'Ù…Ø¤ÙƒØ¯', en: 'Confirmed' },
            'pending': { ar: 'Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±', en: 'Pending' },
            'cancelled': { ar: 'Ù…Ù„ØºÙ‰', en: 'Cancelled' }
          }
        }
      };

      // Translation Helper
      const t = function(key) {
        const lang = db.env.lang || 'ar';
        const dict = db.i18n.dict || {};
        return dict[key] && dict[key][lang] ? dict[key][lang] : key;
      };

      // Event Handlers
      const orders = {
        'nav:click': {
          on: ['click'],
          gkeys: ['nav:click'],
          handler: function(event, context) {
            const page = event.target.dataset.page;
            const state = context.getState();
            state.data.currentPage = page;
            context.rebuild();
          }
        },

        'lang:switch': {
          on: ['click'],
          gkeys: ['lang:switch'],
          handler: function(event, context) {
            const newLang = event.target.dataset.lang;
            const state = context.getState();
            state.env.lang = newLang;
            state.env.dir = newLang === 'ar' ? 'rtl' : 'ltr';
            document.documentElement.setAttribute('lang', newLang);
            document.documentElement.setAttribute('dir', state.env.dir);
            context.rebuild();
          }
        },

        'theme:toggle': {
          on: ['click'],
          gkeys: ['theme:toggle'],
          handler: function(event, context) {
            const state = context.getState();
            state.env.theme = state.env.theme === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', state.env.theme);
            context.rebuild();
          }
        },

        'modal:open': {
          on: ['click'],
          gkeys: ['modal:open'],
          handler: function(event, context) {
            const modalType = event.target.dataset.modalType;
            const state = context.getState();
            state.data.showModal = true;
            state.data.modalType = modalType;
            context.rebuild();
          }
        },

        'modal:close': {
          on: ['click'],
          gkeys: ['modal:close'],
          handler: function(event, context) {
            const state = context.getState();
            state.data.showModal = false;
            state.data.modalType = null;
            context.rebuild();
          }
        }
      };

      // Components
      function Sidebar(db, D) {
        const menuItems = [
          { icon: 'ğŸ“Š', page: 'dashboard', label: t('dashboard') },
          { icon: 'ğŸ‘¥', page: 'patients', label: t('patients') },
          { icon: 'ğŸ“…', page: 'appointments', label: t('appointments') },
          { icon: 'ğŸ’†', page: 'sessions', label: t('sessions') },
          { icon: 'ğŸ“ˆ', page: 'reports', label: t('reports') },
          { icon: 'âš™ï¸', page: 'settings', label: t('settings') }
        ];

        return D.Containers.Aside({
          attrs: { class: tw`w-64 bg-[var(--card)] border-e border-[var(--border)] p-6 fixed h-screen overflow-y-auto ${token('surface')}` }
        }, [
          // Header
          D.Containers.Div({ attrs: { class: tw`mb-8 pb-4 border-b border-[var(--border)]` } }, [
            D.Text.H2({ attrs: { class: tw`text-lg font-bold text-[var(--primary)]` } }, ['ğŸ¥ Ù…Ø±ÙƒØ² Ø§Ù„Ø¹Ù„Ø§Ø¬ Ø§Ù„Ø·Ø¨ÙŠØ¹ÙŠ'])
          ]),

          // Menu
          D.Lists.Ul({ attrs: { class: tw`${token('vstack')} gap-2` } },
            menuItems.map(item =>
              D.Lists.Li({ attrs: { key: item.page } }, [
                D.Text.A({
                  attrs: {
                    class: tw`flex items-center gap-3 px-4 py-3 rounded-lg transition-all duration-200 cursor-pointer ${
                      db.data.currentPage === item.page
                        ? 'bg-[var(--primary)] text-[var(--primary-foreground)] shadow-md'
                        : 'hover:bg-[var(--accent)] text-[var(--foreground)]'
                    }`,
                    'data-m-gkey': 'nav:click',
                    'data-page': item.page
                  }
                }, [
                  D.Text.Span({ attrs: { class: tw`text-xl` } }, [item.icon]),
                  D.Text.Span({ attrs: { class: tw`font-medium` } }, [item.label])
                ])
              ])
            )
          )
        ]);
      }

      function Header(db, D) {
        return D.Containers.Div({ attrs: { class: tw`${token('split')} mb-8 pb-4 border-b border-[var(--border)]` } }, [
          D.Text.H1({ attrs: { class: tw`text-3xl font-bold text-[var(--foreground)]` } }, [t(db.data.currentPage)]),
          D.Containers.Div({ attrs: { class: tw`${token('hstack')} gap-3` } }, [
            UI.Switcher({
              attrs: { 'data-m-gkey': 'lang:switch' },
              value: db.env.lang,
              options: [
                { label: 'Ø¹', value: 'ar', attrs: { 'data-lang': 'ar' } },
                { label: 'EN', value: 'en', attrs: { 'data-lang': 'en' } }
              ]
            }),
            UI.Button({
              attrs: {
                'data-m-gkey': 'theme:toggle',
                title: db.env.theme === 'dark' ? 'Switch to Light Mode' : 'Switch to Dark Mode'
              },
              variant: 'ghost',
              size: 'md'
            }, [db.env.theme === 'dark' ? 'ğŸŒ' : 'ğŸŒ™'])
          ])
        ]);
      }

      function StatCard({ icon, title, value, change, changeType }, D) {
        const changeColors = {
          positive: 'text-green-600 dark:text-green-400',
          neutral: 'text-blue-600 dark:text-blue-400',
          negative: 'text-red-600 dark:text-red-400'
        };

        return D.Containers.Div({ attrs: { class: tw`${token('card')} p-6 hover:shadow-lg transition-shadow duration-200` } }, [
          D.Containers.Div({ attrs: { class: tw`${token('split')} mb-4` } }, [
            D.Text.Span({ attrs: { class: tw`text-sm font-medium ${token('muted')}` } }, [title]),
            D.Text.Span({ attrs: { class: tw`text-2xl` } }, [icon])
          ]),
          D.Containers.Div({ attrs: { class: tw`text-3xl font-bold text-[var(--foreground)] mb-2` } }, [value]),
          D.Containers.Div({ attrs: { class: tw`text-sm ${changeColors[changeType || 'neutral']}` } }, [change])
        ]);
      }

      function StatsGrid(db, D) {
        return D.Containers.Div({ attrs: { class: tw`grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8` } }, [
          StatCard({
            icon: 'ğŸ‘¥',
            title: t('totalPatients'),
            value: String(db.data.stats.totalPatients),
            change: 'â†‘ 12% Ù…Ù† Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ù…Ø§Ø¶ÙŠ',
            changeType: 'positive'
          }, D),
          StatCard({
            icon: 'ğŸ“…',
            title: t('todayAppointments'),
            value: String(db.data.stats.todayAppointments),
            change: '5 Ù…Ø¤ÙƒØ¯ØŒ 7 Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±',
            changeType: 'neutral'
          }, D),
          StatCard({
            icon: 'âœ…',
            title: t('completedSessions'),
            value: String(db.data.stats.completedSessions),
            change: 'â†‘ 8% Ù…Ù† Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ù…Ø§Ø¶ÙŠ',
            changeType: 'positive'
          }, D),
          StatCard({
            icon: 'ğŸ’°',
            title: t('revenue'),
            value: String(db.data.stats.revenue) + ' Ø¬.Ù…',
            change: 'â†‘ 15% Ù…Ù† Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ù…Ø§Ø¶ÙŠ',
            changeType: 'positive'
          }, D)
        ]);
      }

      function DataTable({ title, headers, rows, onAdd }, D) {
        return D.Containers.Div({ attrs: { class: tw`${token('card')} mb-6` } }, [
          // Header
          D.Containers.Div({ attrs: { class: tw`${token('card/header')}` } }, [
            D.Text.H2({ attrs: { class: tw`${token('card/title')}` } }, [title]),
            onAdd ? UI.Button({
              attrs: {
                'data-m-gkey': 'modal:open',
                'data-modal-type': onAdd.type
              },
              variant: 'solid',
              size: 'sm'
            }, ['+ ' + t('addNew')]) : null
          ]),

          // Table
          D.Containers.Div({ attrs: { class: tw`${token('card/content')} overflow-x-auto` } }, [
            D.Containers.Div({ attrs: { class: tw`min-w-full` } }, [
              // Table Header
              D.Containers.Div({ attrs: { class: tw`bg-[var(--surface-1)] border-b-2 border-[var(--border)]` } }, [
                D.Containers.Div({ attrs: { class: tw`grid gap-4 p-4` + ` grid-cols-${headers.length}` } },
                  headers.map(header =>
                    D.Containers.Div({ attrs: { class: tw`text-sm font-semibold text-[var(--foreground)]` } }, [header])
                  )
                )
              ]),

              // Table Body
              D.Containers.Div({},
                rows.map((row, idx) =>
                  D.Containers.Div({
                    attrs: {
                      key: idx,
                      class: tw`border-b border-[var(--border)] hover:bg-[var(--accent)] transition-colors duration-150`
                    }
                  }, [
                    D.Containers.Div({ attrs: { class: tw`grid gap-4 p-4` + ` grid-cols-${headers.length}` } }, row)
                  ])
                )
              )
            ])
          ])
        ]);
      }

      function Badge({ text, variant }, D) {
        const variants = {
          success: 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200',
          warning: 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200',
          danger: 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200',
          info: 'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200'
        };

        return D.Text.Span({
          attrs: {
            class: tw`${token('badge')} ${variants[variant] || variants.info}`
          }
        }, [text]);
      }

      function DashboardPage(db, D) {
        // Patients table
        const patientsHeaders = [t('name'), t('phone'), t('status'), t('lastVisit'), t('sessions')];
        const patientsRows = db.data.patients.map(patient => [
          D.Text.Span({ attrs: { class: tw`font-medium text-[var(--foreground)]` } }, [patient.name]),
          D.Text.Span({ attrs: { class: tw`${token('muted')}` } }, [patient.phone]),
          Badge({
            text: t(patient.status),
            variant: patient.status === 'active' ? 'success' : 'info'
          }, D),
          D.Text.Span({ attrs: { class: tw`${token('muted')}` } }, [patient.lastVisit]),
          D.Text.Span({ attrs: { class: tw`font-semibold text-[var(--primary)]` } }, [String(patient.totalSessions)])
        ]);

        // Appointments table
        const appointmentsHeaders = [t('patient'), t('date'), t('time'), t('service'), t('status')];
        const appointmentsRows = db.data.appointments.map(appointment => [
          D.Text.Span({ attrs: { class: tw`font-medium text-[var(--foreground)]` } }, [appointment.patientName]),
          D.Text.Span({ attrs: { class: tw`${token('muted')}` } }, [appointment.date]),
          D.Text.Span({ attrs: { class: tw`${token('muted')}` } }, [appointment.time]),
          D.Text.Span({ attrs: { class: tw`text-[var(--foreground)]` } }, [appointment.service]),
          Badge({
            text: t(appointment.status),
            variant: appointment.status === 'confirmed' ? 'success' : 'warning'
          }, D)
        ]);

        return D.Containers.Div({}, [
          StatsGrid(db, D),
          DataTable({
            title: t('recentPatients'),
            headers: patientsHeaders,
            rows: patientsRows,
            onAdd: { type: 'patient' }
          }, D),
          DataTable({
            title: t('upcomingAppointments'),
            headers: appointmentsHeaders,
            rows: appointmentsRows,
            onAdd: { type: 'appointment' }
          }, D)
        ]);
      }

      function MainContent(db, D) {
        return D.Containers.Main({ attrs: { class: tw`flex-1 ms-64 p-8 min-h-screen ${token('surface')}` } }, [
          Header(db, D),
          db.data.currentPage === 'dashboard'
            ? DashboardPage(db, D)
            : D.Containers.Div({ attrs: { class: tw`${token('card')} p-12 text-center` } }, [
                D.Text.P({ attrs: { class: tw`text-xl ${token('muted')}` } }, [
                  'ğŸ“‹ ØµÙØ­Ø© ' + t(db.data.currentPage) + ' Ù‚ÙŠØ¯ Ø§Ù„ØªØ·ÙˆÙŠØ±'
                ])
              ])
        ]);
      }

      // Main App Body
      M.app.setBody(function(stateWrapper, D) {
        const state = stateWrapper;

        return D.Containers.Div({ attrs: { class: tw`flex min-h-screen ${token('surface')}` } }, [
          Sidebar(state, D),
          MainContent(state, D)
        ]);
      });

      // Create and Mount App
      const app = M.app.createApp(db, orders);
      app.mount('#app');

      console.log('ERP Dashboard loaded successfully!');
    })();
  </script>
</body>
</html>
