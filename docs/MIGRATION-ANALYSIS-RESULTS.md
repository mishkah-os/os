# ๐ ุชุญููู ุดุงูู ููุชุงุฆุฌ Schema Migration

**ุชุงุฑูุฎ ุงูุชุดุบูู:** 2025-11-05
**ุงููุฑุน:** dar
**ุงูููุฏููู:** pos

---

## ๐ฏ ุงูุฅุฌุงุจุฉ ุงููุจุงุดุฑุฉ
**ูุนูุ ูุดููุฉ ููุฏุงู `item_id` ูุงูุช ูุนูุงู ุจุณุจุจ ูููู SQLite!**

## ๐ ุงูุชูุงุตูู ุงูุชูููุฉ

### ุฌุฏูู `order_line` - ุงูุชุญููู ุงููุงูู

#### โ ุงููุถุน ูุจู Migration:
- ุงูุฌุฏูู **ููุฌูุฏ** ูู SQLite
- ููู ูุงู ูููุตู **10 ุญููู ูููุฉ** ุญุณุจ `definition.json`

#### ๐จ ุงูุญููู ุงูููููุฏุฉ (High Severity):
1. **`item_id`** (TEXT) โญ **ูุฐุง ูู ุณุจุจ ุงููุดููุฉ ุงูุฑุฆูุณู!**
2. `line_id` (TEXT)
3. `kitchen_section_id` (TEXT)
4. `metadata` (TEXT)
5. `notes` (TEXT)
6. `parent_line_id` (TEXT)
7. `quantity` (TEXT)
8. `status_id` (TEXT)
9. `total` (TEXT)
10. `unit_price` (TEXT)

#### ๐ ุงูุญููู ุงูุฅุถุงููุฉ ุงูููุฌูุฏุฉ (Low Severity):
- `id`, `status`, `stage`, `created_at`, `updated_at`
- ูุฐู ุญููู ุงููุธุงู (system columns) - ุนุงุฏูุฉ

#### โจ ุงููุชูุฌุฉ:
```sql
ALTER TABLE order_line ADD COLUMN item_id TEXT DEFAULT ''
```
**ุชู ุจูุฌุงุญ! โ**

---

## ๐ ุงูุฅุญุตุงุฆูุงุช ุงููุงููุฉ

### ุฅุฌูุงูู ุงูุนูููุงุช:
- **78 ุฌุฏูู** ุชู ุฅูุดุงุคู (CREATE TABLE)
- **110 ุญูู** ุชู ุฅุถุงูุชู (ADD COLUMN)
- **0 ุฃุฎุทุงุก** ูู ุงูู migration

### ุงูุฌุฏุงูู ุงูุฑุฆูุณูุฉ ุงููุชุฃุซุฑุฉ:
1. โ `order_line` - ุฃุถูู 10 ุญููู
2. โ `menu_item` - ุชู ุฅูุดุงุคู ูู ุงูุตูุฑ
3. โ `order_payment` - ูุฌุฏุช type mismatch ูู `amount`
4. โ 75 ุฌุฏูู ุขุฎุฑ ุชู ุฅูุดุงุคู

---

## ๐ ุงูุฏุฑูุณ ุงููุณุชูุงุฏุฉ

### 1๏ธโฃ ุงูุณุจุจ ุงูุฌุฐุฑู ูููุดููุฉ:
ูุงู ุฌุฏูู `order_line` ูู SQLite **ูุง ูุญุชูู** ุนูู ุญูู `item_id` ุฃุตูุงู!

ุนูุฏูุง ูุงู ุงูุชุทุจูู ูุญุงูู ุญูุธ `item_id`:
```javascript
// ูู ุงูููุฏ
record.itemId = "some-uuid-value"

// ููู ูู SQLite
// order_line table ูู ููู ูู column ุงุณูู item_id
// ุงููุชูุฌุฉ: silent fail โ item_id = null
```

### 2๏ธโฃ ููุงุฐุง ูุงูุช ุงููุดููุฉ "ุตุงูุชุฉ"ุ
- SQLite ูู ูุฑูู error
- ุงููุธุงู ูุงู ูุญูุธ ุงูุจูุงูุงุช ูู `payload` (JSON) ุจูุฌุงุญ
- ููู ุงูุญููู ุงููุฑุฏูุฉ (indexed columns) ูู ุชูู ููุฌูุฏุฉ
- ูุฐูู queries ุงูุชู ุชุนุชูุฏ ุนูู `item_id` ูุงูุช ุชูุดู

### 3๏ธโฃ ุงููุฑู ุจูู INTEGER ู STRING:
**ูู ุชูู ูุฐู ุงููุดููุฉ!**
- ูุง ููุฌุฏ **type mismatch** ูู `order_line`
- ุงูุญูู ุจุจุณุงุทุฉ **ุบูุฑ ููุฌูุฏ**
- ุงููุธุงู ุงูุฌุฏูุฏ ุฃุถุงูู ูู TEXT (ุตุญูุญ) โ

---

## ๐ง ุงููุดุงูู ุงูุฃุฎุฑู ุงูููุชุดูุฉ

### โ๏ธ Type Mismatch ูู `order_payment`:
```
Column: amount
Actual: REAL
Expected: TEXT
Status: Requires Manual Migration
```

ูุฐู ุชุญุชุงุฌ manual migration ูุงุญููุง.

### ๐ ููู ุงูู Logs ุงููุงูู:
```
data/branches/dar/modules/pos/logs/
  โโโ ddl-2025-11-05.log (78KB)
  โโโ migration-2025-11-05.log (81KB)
  โโโ (ุชุญุชูู ุนูู ุชูุงุตูู ูุงููุฉ ููู ุนูููุฉ)
```

---

## โ ุงูุญุงูุฉ ุงูุญุงููุฉ

### ุจุนุฏ Migration:
1. โ ุฌุฏูู `order_line` ุงูุขู ุจู `item_id TEXT`
2. โ ุฌููุน ุงูุฌุฏุงูู ุงููุทููุจุฉ ููุฌูุฏุฉ (78 ุฌุฏูู ุฌุฏูุฏ)
3. โ ุฌููุน ุงูุญููู ุงูููููุฏุฉ ุชูุช ุฅุถุงูุชูุง (110 ุญูู)
4. โ ุงููุธุงู ุฌุงูุฒ ููุนูู ุจุดูู ุตุญูุญ

### ุงูุชูุตูุงุช:
1. **ุงุฎุชุจุงุฑ ููุฑู**: ุชุฃูุฏ ูู ุฃู `item_id` ุงูุขู ููุญูุธ ุจุดูู ุตุญูุญ
2. **ูุฑุงูุจุฉ ุงูู logs**: ุชุงุจุน `data/branches/dar/modules/pos/logs/`
3. **Manual Migration ูุงุญููุง**: ูุญูู `amount` ูู `order_payment`
4. **ุงุฎุชุจุงุฑ ุงูุจูุงูุงุช ุงููุฏููุฉ**: ุงูุณุฌูุงุช ุงููุฏููุฉ ูุฏ ูููู ููุง `item_id = ''` (default value)

---

## ๐ ุงูุชุญูู ูู ุงููุฌุงุญ

### ููู ุชุชุฃูุฏ ุฃู ุงููุดููุฉ ูุญูููุฉุ

```sql
-- 1. ุชุญูู ูู ูุฌูุฏ ุงูุญูู
PRAGMA table_info(order_line);
-- ูุฌุจ ุฃู ุชุฑู: item_id | TEXT | 0 | '' | 0

-- 2. ุงุฎุชุจุฑ ุฅุฏุฎุงู ุจูุงูุงุช ุฌุฏูุฏุฉ
INSERT INTO order_line (..., item_id, ...) VALUES (..., 'test-uuid', ...);

-- 3. ุชุญูู ูู ุงูุจูุงูุงุช
SELECT item_id FROM order_line WHERE item_id != '';
```

### ูู ุงูุชุทุจูู:
```javascript
// ุจุนุฏ ุญูุธ order line ุฌุฏูุฏ
console.log('item_id:', orderLine.itemId);
// ูุฌุจ ุฃูุง ูููู null ุจุนุฏ ุงูุขู!
```

---

## ๐ ุงูุฎูุงุตุฉ

**ุงููุธุงู ุงูุฌุฏูุฏ ูุฌุญ ูู:**
- โ ุงูุชุดุงู ุงููุดููุฉ ุงูุญููููุฉ (ุงูุญูู ููููุฏ ุชูุงููุง)
- โ ุฅุตูุงุญูุง ุชููุงุฆููุง (ALTER TABLE ADD COLUMN)
- โ ุชูุซูู ูู ุดูุก ูู logs ููุตูุฉ
- โ ุญูุงูุฉ ุงูุจูุงูุงุช (ูุง dropsุ ููุท ADD)

**ูุดููุฉ `item_id = null` ูุฌุจ ุฃู ุชููู ูุญูููุฉ ุงูุขู! ๐ฏ**

---

## ๐ ุงููุชุงุจุนุฉ

ุฅุฐุง ุงุณุชูุฑุช ุงููุดููุฉ ุจุนุฏ ุงูู migration:
1. ุฑุงุฌุน ุงูู logs ูู `data/branches/dar/modules/pos/logs/`
2. ุชุญูู ูู `PRAGMA table_info(order_line)`
3. ุชุฃูุฏ ุฃู ุงูุชุทุจูู ูุณุชุฎุฏู database ุงููุญุฏุซ
4. ุชุญูู ูู ุฃู ุงูู cache ูู better-sqlite3 ุชู ุชุญุฏูุซู

---

**ุชู ุฅูุดุงุก ูุฐุง ุงูุชูุฑูุฑ ุจูุงุณุทุฉ:** Schema Migration System
**ุงููุณุฎุฉ:** 1.0
**ุงูุชุงุฑูุฎ:** 2025-11-05
