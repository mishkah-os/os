# تقرير الوضع الحالي للتطبيق اللحظي

## 1. القدرات الحالية (ما يعمل اليوم)

### 1.1 البث اللحظي عبر WebSocket
- يتم إنشاء إطار Snapshot كامل عند اشتراك أي جهاز جديد لضمان أن الواجهات لا تبقى في حالة انتظار.
- وظيفة `serializeOnce` تعيد استخدام نفس السلسلة أو المخرجات الثنائية لكل المشتركين، مما يقلل استهلاك CPU ويضمن ثبات الإرسال أثناء ساعات الذروة.
- نظام الدلتا يرسل التغييرات المتدرجة عند وجود تحديثات صغيرة، بينما يعود تلقائياً إلى الإرسال الكامل عندما تكون الفروقات كبيرة أو غير معروفة، ما يحافظ على توافق واجهات POS الحالية.

### 1.2 التخزين الهجين (HybridStore + SQLite)
- البيانات النشطة (طلبات مفتوحة، مدفوعات جارية) تبقى في الذاكرة للوصول السريع.
- كل عملية إدراج أو تعديل تُكتب فوراً في SQLite لضمان الديمومة اليومية قبل ترحيل البيانات إلى النظام المركزي.
- يقوم HybridStore بإعادة تحميل الجداول الباردة عند الحاجة، ويُبقي ذاكرة العملية ضمن حدود ثابتة خلال اليوم.

### 1.3 ضوابط التزامن
- كل سجل يحمل حقل `version` يتم التحقق منه قبل أي تعديل؛ في حالة اختلاف النسخة يتم رفض العملية بخطأ 409 مع تفاصيل تساعد المستخدم على إعادة المحاولة.
- هذا السلوك يمنع ضياع المدفوعات أو إلغاء تحديثات النادل عند وجود تنافس بين الأجهزة.

### 1.4 تكامل واجهات العرض
- الـ POS والـ KDS يستقبلان رسائل `snapshot` و `delta` بنمط موحّد، ما يسمح بتشغيل أكثر من شاشة لكل فرع دون الحاجة إلى إعادة الاتصال.
- عند إعادة تشغيل الجهاز أثناء اليوم، يحصل على Snapshot جديدة من نفس الفرع ثم يلحق بالدلتا دون الحاجة إلى تحميل كامل من API خارجي.

## 2. نقاط الضعف الحرجة المتبقية

| الخطر | الأثر | الوضع الحالي |
|-------|-------|---------------|
| تدوير سجل الأحداث (Event Log Rotation) | احتمال فقدان بيانات عند تدوير الملفات الكبيرة أو إيقاف الخدمة أثناء النقل | ما زال يعتمد على `rename` المباشر بدون خطوات تحقق أو استعادة |
| أداء مقارنة الدلتا (`deepEqual`) | في حالة وجود أوامر ضخمة قد تصبح المقارنة O(n) وتستهلك وقتاً ملحوظاً | قيد المراقبة؛ لم تظهر أزمة بعد لكن قد تظهر مع توسع الفروع |
| مراقبة الصحة (Observability) | صعوبة تتبع التأخيرات أو حالات الانقطاع لحظياً | تتوفر سجلات Debug، لكن لا توجد لوحات مراقبة أو تنبيهات تلقائية |
| اختبار التوافق للإصدارات القديمة | بعض العملاء الأقدم قد لا يتعامل مع دلتا معقّدة | نعتمد حالياً على المسارات المشتركة في الواجهات الحالية فقط |

## 3. خطة الإحكام المستقبلية

### 3.1 جعل تدوير السجلات آمناً
1. بناء إجراء نسخ تدريجي: نسخ الملف إلى موقع مؤقت، التحقق من سلامة الحجم/الهاش، ثم الانتقال الذري.
2. إضافة آلية استئناف في حال انقطاع الكهرباء خلال عملية التدوير.
3. إضافة اختبارات تحميل تُحاكي تدويراً أثناء الذروة لضمان عدم تعطل البث.

### 3.2 تحسين أداء الدلتا
1. استبدال `deepEqual` بمحرك مقارنة أسرع (`fast-deep-equal` أو مقارنة قائمة على الـ hash).
2. تفعيل تتبع مقاييس للوقت المستغرق في بناء الدلتا لتحديد الجداول التي تحتاج معاملة خاصة.
3. إتاحة خيار إرسال Snapshot كامل عندما تتجاوز الدلتا حجم عتبة محددة.

### 3.3 تعزيز المراقبة
1. إضافة عدّادات Prometheus (عدد الاتصالات، زمن بناء Snapshot، حجم الرسائل).
2. ربط العدادات مع Dashboard بسيطة ومؤشرات تنبيه عند تجاوز حدود معينة (latency، dropped frames).
3. تفعيل تتبع لعمليات التزامن المرفوضة لتقييم الحاجة إلى تحسينات إضافية في تجربة المستخدم.

### 3.4 خطة التدرج نحو منصة تخزين أوسع
1. تجهيز واجهات REST/GraphQL لقراءة أرشيف اليوم السابق من النظام المركزي (كمصدر ثانوي للقراءة).
2. إضافة طبقة تكامل مع IndexedDB في الواجهة الأمامية لتحسين تجربة العمل دون اتصال مؤقت.
3. وضع إستراتيجية Cache Invalidation مشتركة بين WebSocket و IndexedDB لضمان اتساق البيانات عند العودة من وضع عدم الاتصال.

## 4. خلاصة
- التطبيق الحالي مستقر لاحتياجات اليوم/اليومين قبل التفريغ المركزي، ويمنح الأجهزة القدرة على العمل المتزامن دون فقدان بيانات.
- هناك قائمة واضحة من التحسينات لرفع الاعتمادية تمهيداً لتوسعة المنظومة إلى منصة تخزين متكاملة بين WebSocket و IndexedDB.
- متابعة تنفيذ الخطة أعلاه خطوة بخطوة هي الطريق الآمن لتحويل النواة الحالية إلى نظام موزع كامل دون مفاجآت في الإنتاج.
