<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ŸÑŸàÿ≠ÿ© ÿßŸÑÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑŸÖŸàÿ±ŸÅŸàŸÑŸàÿ¨Ÿä - Arabic Morphological Dashboard</title>

    <!-- Mishkah Core -->
    <script src="../../static/lib/mishkah.core.js"></script>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

    <!-- Arabic Support Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/arabic-reshaper@2.1.1/dist/arabic-reshaper.min.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            font-family: 'Segoe UI', 'Courier New', monospace;
            background: #f5f5f5;
            color: #333;
        }

        body {
            padding: 20px;
            direction: rtl;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px 20px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .toolbar {
            background: #f9f9f9;
            padding: 20px;
            border-bottom: 1px solid #ddd;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }

        .search-box {
            flex: 1;
            min-width: 250px;
        }

        .search-box input {
            width: 100%;
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1em;
        }

        .toolbar button {
            padding: 10px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1em;
            transition: background 0.3s;
        }

        .toolbar button:hover {
            background: #5568d3;
        }

        .content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            padding: 20px;
        }

        @media (max-width: 1024px) {
            .content {
                grid-template-columns: 1fr;
            }
        }

        .card {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            overflow: auto;
        }

        .card h2 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .stat-box {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-box .number {
            font-size: 2em;
            font-weight: bold;
            margin: 10px 0;
        }

        .stat-box .label {
            font-size: 0.9em;
            opacity: 0.9;
        }

        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        table th {
            background: #f0f0f0;
            padding: 12px;
            text-align: right;
            font-weight: bold;
            border-bottom: 2px solid #ddd;
        }

        table td {
            padding: 10px 12px;
            border-bottom: 1px solid #eee;
        }

        table tr:hover {
            background: #f9f9f9;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .error {
            background: #fee;
            color: #c00;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
        }

        .success {
            background: #efe;
            color: #0c0;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
        }

        .chart-container {
            position: relative;
            height: 300px;
            margin: 20px 0;
        }

        .filter-section {
            background: #f9f9f9;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
        }

        .filter-section label {
            display: inline-block;
            margin-right: 10px;
            font-weight: bold;
        }

        .filter-section select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1em;
        }

        .word-entry {
            background: #f9f9f9;
            padding: 15px;
            margin: 10px 0;
            border-right: 4px solid #667eea;
            border-radius: 4px;
        }

        .word-entry strong {
            color: #667eea;
            font-size: 1.1em;
        }

        .word-entry .root {
            color: #764ba2;
            font-weight: bold;
        }

        .word-entry .tags {
            display: inline-block;
            background: #667eea;
            color: white;
            padding: 4px 8px;
            border-radius: 3px;
            margin-top: 10px;
            font-size: 0.9em;
        }

        .location-info {
            font-size: 0.9em;
            color: #666;
            margin-top: 8px;
        }

        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .grid-3 {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
        }

        @media (max-width: 768px) {
            .grid-2, .grid-3 {
                grid-template-columns: 1fr;
            }

            .header h1 {
                font-size: 1.8em;
            }
        }
    </style>
</head>
<body>
    <div id="app"></div>

    <script>
    (async function() {
        const M = Mishkah;
        const D = M.DSL;
        const UI = M.UI;
        const U = M.utils;

        // ============================================
        // 1. DATABASE - ŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™
        // ============================================
        const db = {
            env: {
                lang: 'ar',
                theme: 'light',
                dir: 'rtl'
            },

            data: {
                // Data management
                loading: true,
                error: null,
                success: null,

                // Morphological data
                wordsData: [],           // Array of morphological analysis from final/*.json
                wordsRef: [],            // Array of word locations from words-ref.json
                wordIndex: {},           // Dictionary for quick lookup

                // UI state
                searchQuery: '',
                selectedWord: null,
                filteredWords: [],
                currentTab: 'overview',  // 'overview', 'search', 'statistics'

                // Statistics
                stats: {
                    totalWords: 0,
                    uniqueWords: 0,
                    totalRoots: 0,
                    uniqueRoots: 0,
                    tagFrequency: {},
                    rootFrequency: {},
                    wordFrequency: {}
                }
            }
        };

        // ============================================
        // 2. DATA LOADING - ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™
        // ============================================
        async function loadData() {
            try {
                console.log('üìÇ ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™...');

                // Load all final JSON files
                const finalData = [];
                for (let i = 1; i <= 15; i++) {
                    const fileNum = String(i).padStart(2, '0');
                    const response = await fetch(`./final/final_${fileNum}.json`);
                    if (!response.ok) throw new Error(`Failed to load final_${fileNum}.json`);
                    const data = await response.json();
                    finalData.push(...data);
                }

                // Load words-ref.json
                const refResponse = await fetch('./words-ref.json');
                if (!refResponse.ok) throw new Error('Failed to load words-ref.json');
                const wordsRef = await refResponse.json();

                db.data.wordsData = finalData;
                db.data.wordsRef = wordsRef;

                // Build index
                finalData.forEach((word, idx) => {
                    db.data.wordIndex[word[0]] = idx;
                });

                // Calculate statistics
                calculateStatistics();

                db.data.loading = false;
                db.data.success = `‚úì ÿ™ŸÖ ÿ™ÿ≠ŸÖŸäŸÑ ${finalData.length} ŸÉŸÑŸÖÿ© ÿ®ŸÜÿ¨ÿßÿ≠`;
                console.log('‚úì ÿ™ŸÖ ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿ®ŸÜÿ¨ÿßÿ≠');

                return true;
            } catch (error) {
                console.error('‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™:', error);
                db.data.loading = false;
                db.data.error = `‚ùå ÿÆÿ∑ÿ£: ${error.message}`;
                return false;
            }
        }

        function calculateStatistics() {
            const stats = db.data.stats;
            const wordsData = db.data.wordsData;

            const uniqueWordsSet = new Set();
            const uniqueRootsSet = new Set();
            const tagFreq = {};
            const rootFreq = {};
            const wordFreq = {};

            wordsData.forEach(([word, root, tags]) => {
                // Count unique words and roots
                uniqueWordsSet.add(word);
                uniqueRootsSet.add(root);

                // Count frequencies
                wordFreq[word] = (wordFreq[word] || 0) + 1;
                rootFreq[root] = (rootFreq[root] || 0) + 1;

                // Count tag frequencies
                if (tags) {
                    const tagList = tags.split(',');
                    tagList.forEach(tag => {
                        tagFreq[tag.trim()] = (tagFreq[tag.trim()] || 0) + 1;
                    });
                }
            });

            stats.totalWords = wordsData.length;
            stats.uniqueWords = uniqueWordsSet.size;
            stats.totalRoots = wordsData.filter(w => w[1] && w[1] !== 'NTWS').length;
            stats.uniqueRoots = uniqueRootsSet.size;
            stats.tagFrequency = tagFreq;
            stats.rootFrequency = rootFreq;
            stats.wordFrequency = wordFreq;
        }

        // ============================================
        // 3. SEARCH & FILTER - ÿßŸÑÿ®ÿ≠ÿ´ ŸàÿßŸÑÿ™ÿµŸÅŸäÿ©
        // ============================================
        function performSearch(query) {
            if (!query) {
                db.data.filteredWords = [];
                return;
            }

            const q = query.toLowerCase();
            db.data.filteredWords = db.data.wordsData.filter(([word, root, tags]) => {
                return word.includes(query) ||
                       root.includes(q) ||
                       (tags && tags.includes(q));
            });
        }

        // ============================================
        // 4. ORDERS - ŸÖÿπÿßŸÑÿ¨ÿßÿ™ ÿßŸÑÿ£ÿ≠ÿØÿßÿ´
        // ============================================
        const orders = {
            'search:input': function(event, context) {
                const query = event.target.value;
                context.db.data.searchQuery = query;
                performSearch(query);
                context.rebuild();
            },

            'search:clear': function(event, context) {
                context.db.data.searchQuery = '';
                context.db.data.filteredWords = [];
                context.rebuild();
            },

            'tab:click': function(event, context) {
                const tabName = event.target.dataset.tab;
                context.db.data.currentTab = tabName;
                context.rebuild();
            },

            'word:select': function(event, context) {
                const wordIndex = parseInt(event.target.dataset.wordIndex);
                context.db.data.selectedWord = context.db.data.wordsData[wordIndex];
                context.rebuild();
            }
        };

        // ============================================
        // 5. UI BODY - ÿßŸÑŸàÿßÿ¨Ÿáÿ©
        // ============================================
        M.app.setBody((stateWrapper, D) => {
            const state = stateWrapper.data;

            // Loading state
            if (state.loading) {
                return D.Containers.Div({ attrs: { class: 'container' } }, [
                    D.Containers.Div({ attrs: { class: 'header' } }, [
                        D.Text.H1({}, ['ŸÑŸàÿ≠ÿ© ÿßŸÑÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑŸÖŸàÿ±ŸÅŸàŸÑŸàÿ¨Ÿä']),
                        D.Text.P({}, ['Arabic Morphological Analysis Dashboard'])
                    ]),
                    D.Containers.Div({ attrs: { class: 'loading' } }, [
                        D.Containers.Div({ attrs: { class: 'spinner' } }),
                        D.Text.P({}, ['ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™...'])
                    ])
                ]);
            }

            // Error state
            if (state.error) {
                return D.Containers.Div({ attrs: { class: 'container' } }, [
                    D.Containers.Div({ attrs: { class: 'header' } }, [
                        D.Text.H1({}, ['ŸÑŸàÿ≠ÿ© ÿßŸÑÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑŸÖŸàÿ±ŸÅŸàŸÑŸàÿ¨Ÿä'])
                    ]),
                    D.Containers.Div({ attrs: { class: 'content' } }, [
                        D.Containers.Div({ attrs: { class: 'error' } }, [state.error])
                    ])
                ]);
            }

            // Main UI
            return D.Containers.Div({ attrs: { class: 'container' } }, [
                // Header
                D.Containers.Div({ attrs: { class: 'header' } }, [
                    D.Text.H1({}, ['üìä ŸÑŸàÿ≠ÿ© ÿßŸÑÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑŸÖŸàÿ±ŸÅŸàŸÑŸàÿ¨Ÿä ÿßŸÑÿπÿ±ÿ®Ÿä']),
                    D.Text.P({}, ['Arabic Morphological Analysis Dashboard'])
                ]),

                // Success message
                state.success ? D.Containers.Div({ attrs: { class: 'success' } }, [state.success]) : null,

                // Toolbar
                D.Containers.Div({ attrs: { class: 'toolbar' } }, [
                    D.Containers.Div({ attrs: { class: 'search-box' } }, [
                        D.Inputs.Input({
                            attrs: {
                                type: 'search',
                                placeholder: 'ÿßÿ®ÿ≠ÿ´ ÿπŸÜ ŸÉŸÑŸÖÿ© ÿ£Ÿà ÿ¨ÿ∞ÿ± ÿ£Ÿà ÿ™ÿµŸÜŸäŸÅ...',
                                value: state.searchQuery,
                                gkey: 'search:input'
                            }
                        })
                    ]),
                    state.searchQuery ? D.Forms.Button({
                        attrs: { gkey: 'search:clear' }
                    }, ['ŸÖÿ≥ÿ≠']) : null
                ]),

                // Tabs
                D.Containers.Div({ attrs: { class: 'toolbar', style: 'background: #e9ecef; gap: 0;' } }, [
                    ['overview', 'ŸÜÿ∏ÿ±ÿ© ÿπÿßŸÖÿ©'],
                    ['search', 'ÿßŸÑÿ®ÿ≠ÿ´'],
                    ['statistics', 'ÿßŸÑÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™']
                ].map(([tabId, label]) =>
                    D.Forms.Button({
                        attrs: {
                            gkey: 'tab:click',
                            'data-tab': tabId,
                            style: state.currentTab === tabId ?
                                'background: #667eea; color: white;' :
                                'background: transparent; color: #333; border: none; border-bottom: 3px solid transparent;'
                        }
                    }, [label])
                ),

                // Content based on tab
                renderTabContent(state, D)
            ].filter(Boolean));
        });

        function renderTabContent(state, D) {
            switch(state.currentTab) {
                case 'overview':
                    return renderOverviewTab(state, D);
                case 'search':
                    return renderSearchTab(state, D);
                case 'statistics':
                    return renderStatisticsTab(state, D);
                default:
                    return null;
            }
        }

        function renderOverviewTab(state, D) {
            const stats = state.stats;
            return D.Containers.Div({ attrs: { class: 'content' } }, [
                D.Containers.Div({ attrs: { class: 'card' } }, [
                    D.Text.H2({}, ['ÿßŸÑÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ ÿßŸÑÿ£ÿ≥ÿßÿ≥Ÿäÿ©']),
                    D.Containers.Div({ attrs: { class: 'stats-grid' } }, [
                        renderStatBox('üìä ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑŸÉŸÑŸÖÿßÿ™', stats.totalWords),
                        renderStatBox('üî§ ŸÉŸÑŸÖÿßÿ™ ŸÅÿ±ŸäÿØÿ©', stats.uniqueWords),
                        renderStatBox('üå≥ ÿ¨ÿ∞Ÿàÿ± ŸÅÿ±ŸäÿØÿ©', stats.uniqueRoots),
                        renderStatBox('üìö ŸÉŸÑŸÖÿßÿ™ ŸÖÿπÿ±ÿ®ÿ©', stats.totalRoots)
                    ])
                ]),

                D.Containers.Div({ attrs: { class: 'card' } }, [
                    D.Text.H2({}, ['ÿ£ŸÉÿ´ÿ± ÿßŸÑŸÉŸÑŸÖÿßÿ™ ÿ™ŸÉÿ±ÿßÿ±ÿßŸã']),
                    D.Containers.Div({ attrs: { class: 'table-container' } }, [
                        D.Tables.Table({}, [
                            D.Tables.Thead({}, [
                                D.Tables.Tr({}, [
                                    D.Tables.Th({}, ['ÿßŸÑŸÉŸÑŸÖÿ©']),
                                    D.Tables.Th({}, ['ÿßŸÑÿ™ŸÉÿ±ÿßÿ±']),
                                    D.Tables.Th({}, ['ÿßŸÑŸÜÿ≥ÿ®ÿ©'])
                                ])
                            ]),
                            D.Tables.Tbody({}, Object.entries(stats.wordFrequency)
                                .sort((a, b) => b[1] - a[1])
                                .slice(0, 10)
                                .map(([word, freq]) => D.Tables.Tr({}, [
                                    D.Tables.Td({}, [D.Text.Strong({}, [word])]),
                                    D.Tables.Td({}, [String(freq)]),
                                    D.Tables.Td({}, [((freq / stats.totalWords) * 100).toFixed(2) + '%'])
                                ]))
                            )
                        ])
                    ])
                ])
            ]);
        }

        function renderSearchTab(state, D) {
            return D.Containers.Div({ attrs: { class: 'content' } }, [
                D.Containers.Div({ attrs: { style: 'grid-column: 1 / -1;' } }, [
                    D.Containers.Div({ attrs: { class: 'card' } }, [
                        D.Text.H2({}, ['ŸÜÿ™ÿßÿ¶ÿ¨ ÿßŸÑÿ®ÿ≠ÿ´']),
                        state.filteredWords.length === 0 && state.searchQuery ?
                            D.Text.P({}, ['ŸÑŸÖ Ÿäÿ™ŸÖ ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ŸÜÿ™ÿßÿ¶ÿ¨']) :
                            D.Containers.Div({}, state.filteredWords.slice(0, 20).map(([word, root, tags]) =>
                                D.Containers.Div({ attrs: { class: 'word-entry' } }, [
                                    D.Text.Strong({}, [word]),
                                    D.Text.P({}, [
                                        'ÿßŸÑÿ¨ÿ∞ÿ±: ',
                                        D.Text.Span({ attrs: { class: 'root' } }, [root])
                                    ]),
                                    D.Containers.Div({ attrs: { class: 'tags' } }, [
                                        'ÿßŸÑÿ™ÿµŸÜŸäŸÅÿßÿ™: ' + (tags || 'ÿ∫Ÿäÿ± ŸÖÿπÿ±ŸàŸÅ')
                                    ])
                                ])
                            ))
                    ])
                ])
            ]);
        }

        function renderStatisticsTab(state, D) {
            const stats = state.stats;
            const topRoots = Object.entries(stats.rootFrequency)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);

            return D.Containers.Div({ attrs: { class: 'content' } }, [
                D.Containers.Div({ attrs: { class: 'card' } }, [
                    D.Text.H2({}, ['ÿ™Ÿàÿ≤Ÿäÿπ ÿßŸÑÿ™ÿµŸÜŸäŸÅÿßÿ™ (Tags)']),
                    D.Containers.Div({ attrs: { class: 'table-container' } }, [
                        D.Tables.Table({}, [
                            D.Tables.Thead({}, [
                                D.Tables.Tr({}, [
                                    D.Tables.Th({}, ['ÿßŸÑÿ™ÿµŸÜŸäŸÅ']),
                                    D.Tables.Th({}, ['ÿßŸÑÿ™ŸÉÿ±ÿßÿ±']),
                                    D.Tables.Th({}, ['ÿßŸÑŸÜÿ≥ÿ®ÿ©'])
                                ])
                            ]),
                            D.Tables.Tbody({}, Object.entries(stats.tagFrequency)
                                .sort((a, b) => b[1] - a[1])
                                .slice(0, 15)
                                .map(([tag, freq]) => D.Tables.Tr({}, [
                                    D.Tables.Td({}, [tag]),
                                    D.Tables.Td({}, [String(freq)]),
                                    D.Tables.Td({}, [((freq / stats.totalWords) * 100).toFixed(2) + '%'])
                                ]))
                            )
                        ])
                    ])
                ]),

                D.Containers.Div({ attrs: { class: 'card' } }, [
                    D.Text.H2({}, ['ÿ£ŸÉÿ´ÿ± ÿßŸÑÿ¨ÿ∞Ÿàÿ± ÿ™ŸÉÿ±ÿßÿ±ÿßŸã']),
                    D.Containers.Div({ attrs: { class: 'table-container' } }, [
                        D.Tables.Table({}, [
                            D.Tables.Thead({}, [
                                D.Tables.Tr({}, [
                                    D.Tables.Th({}, ['ÿßŸÑÿ¨ÿ∞ÿ±']),
                                    D.Tables.Th({}, ['ÿßŸÑÿ™ŸÉÿ±ÿßÿ±'])
                                ])
                            ]),
                            D.Tables.Tbody({}, topRoots.map(([root, freq]) => D.Tables.Tr({}, [
                                D.Tables.Td({}, [D.Text.Strong({ attrs: { class: 'root' } }, [root])]),
                                D.Tables.Td({}, [String(freq)])
                            ])))
                        ])
                    ])
                ])
            ]);
        }

        function renderStatBox(label, value) {
            return D.Containers.Div({ attrs: { class: 'stat-box' } }, [
                D.Text.P({ attrs: { class: 'label' } }, [label]),
                D.Text.P({ attrs: { class: 'number' } }, [String(value)])
            ]);
        }

        // ============================================
        // 6. INITIALIZATION - ÿßŸÑÿ™ŸáŸäÿ¶ÿ©
        // ============================================

        // Create and mount app
        const app = M.app.createApp(db, orders);
        app.mount('#app');

        // Load data after mounting
        const dataLoaded = await loadData();
        if (dataLoaded) {
            app.rebuild();
        }

        console.log('‚úÖ ÿ™ŸÖ ÿ™ÿ¥ÿ∫ŸäŸÑ ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ ÿ®ŸÜÿ¨ÿßÿ≠');

    })();
    </script>
</body>
</html>
